<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'><head><title>/var/lib/gems/1.8/gems/RedCloth-3.0.4/lib/redcloth.rb - C0 code coverage information</title>
    <style type='text/css'>body { background-color: rgb(240, 240, 245); }</style>
    <style type='text/css'>span.cross-ref-title {
 font-size: 140%;
}
span.cross-ref a {
 text-decoration: none;
}
span.cross-ref {
 background-color:#f3f7fa;
 border: 1px dashed #333;
 margin: 1em;
 padding: 0.5em;
 overflow: hidden;
}
a.crossref-toggle {
 text-decoration: none;
}
span.marked0 {
 background-color: rgb(185, 210, 200);
 display: block;
}
span.marked1 {
 background-color: rgb(190, 215, 205);
 display: block;
}
span.inferred0 {
 background-color: rgb(175, 200, 200);
 display: block;
}
span.inferred1 {
 background-color: rgb(180, 205, 205);
 display: block;
}
span.uncovered0 {
 background-color: rgb(225, 110, 110);
 display: block;
}
span.uncovered1 {
 background-color: rgb(235, 120, 120);
 display: block;
}
span.overview {
 border-bottom: 8px solid black;
}
div.overview {
 border-bottom: 8px solid black;
}
body {
 font-family: verdana, arial, helvetica;
}
div.footer {
 font-size: 68%;
 margin-top: 1.5em;
}
h1, h2, h3, h4, h5, h6 {
 margin-bottom: 0.5em;
}
h5 {
 margin-top: 0.5em;
}
.hidden {
 display: none;
}
div.separator {
 height: 10px;
}
/* Commented out for better readability, esp. on IE */
/*
table tr td, table tr th {
 font-size: 68%;
}
td.value table tr td {
 font-size: 11px;
}
*/
table.percent_graph {
 height: 12px;
 border: #808080 1px solid;
 empty-cells: show;
}
table.percent_graph td.covered {
 height: 10px;
 background: #00f000;
}
table.percent_graph td.uncovered {
 height: 10px;
 background: #e00000;
}
table.percent_graph td.NA {
 height: 10px;
 background: #eaeaea;
}
table.report {
 border-collapse: collapse;
 width: 100%;
}
table.report td.heading {
 background: #dcecff;
 border: #d0d0d0 1px solid;
 font-weight: bold;
 text-align: center;
}
table.report td.heading:hover {
 background: #c0ffc0;
}
table.report td.text {
 border: #d0d0d0 1px solid;
}
table.report td.value,
table.report td.lines_total,
table.report td.lines_code {
 text-align: right;
 border: #d0d0d0 1px solid;
}
table.report tr.light {
 background-color: rgb(240, 240, 245);
}
table.report tr.dark {
 background-color: rgb(230, 230, 235);
}
</style>
    <script type='text/javascript'>
// <![CDATA[
  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make cross-references hidden by default
  document.writeln( "<style type=\"text/css\">span.cross-ref { display: none }</style>" )
  // ]]>
</script>
    <style type='text/css'>span.run0 {
  background-color: rgb(178, 204, 255);
  display: block;
}
span.run1 {
  background-color: rgb(178, 206, 255);
  display: block;
}
span.run2 {
  background-color: rgb(178, 209, 255);
  display: block;
}
span.run3 {
  background-color: rgb(178, 211, 255);
  display: block;
}
span.run4 {
  background-color: rgb(178, 214, 255);
  display: block;
}
span.run5 {
  background-color: rgb(178, 218, 255);
  display: block;
}
span.run6 {
  background-color: rgb(178, 220, 255);
  display: block;
}
span.run7 {
  background-color: rgb(178, 223, 255);
  display: block;
}
span.run8 {
  background-color: rgb(178, 225, 255);
  display: block;
}
span.run9 {
  background-color: rgb(178, 228, 255);
  display: block;
}
span.run10 {
  background-color: rgb(178, 232, 255);
  display: block;
}
span.run11 {
  background-color: rgb(178, 234, 255);
  display: block;
}
span.run12 {
  background-color: rgb(178, 237, 255);
  display: block;
}
span.run13 {
  background-color: rgb(178, 239, 255);
  display: block;
}
span.run14 {
  background-color: rgb(178, 242, 255);
  display: block;
}
span.run15 {
  background-color: rgb(178, 246, 255);
  display: block;
}
span.run16 {
  background-color: rgb(178, 248, 255);
  display: block;
}
span.run17 {
  background-color: rgb(178, 251, 255);
  display: block;
}
span.run18 {
  background-color: rgb(178, 253, 255);
  display: block;
}
span.run19 {
  background-color: rgb(178, 255, 253);
  display: block;
}
span.run20 {
  background-color: rgb(178, 255, 249);
  display: block;
}
span.run21 {
  background-color: rgb(178, 255, 247);
  display: block;
}
span.run22 {
  background-color: rgb(178, 255, 244);
  display: block;
}
span.run23 {
  background-color: rgb(178, 255, 242);
  display: block;
}
span.run24 {
  background-color: rgb(178, 255, 239);
  display: block;
}
span.run25 {
  background-color: rgb(178, 255, 235);
  display: block;
}
span.run26 {
  background-color: rgb(178, 255, 233);
  display: block;
}
span.run27 {
  background-color: rgb(178, 255, 230);
  display: block;
}
span.run28 {
  background-color: rgb(178, 255, 228);
  display: block;
}
span.run29 {
  background-color: rgb(178, 255, 225);
  display: block;
}
span.run30 {
  background-color: rgb(178, 255, 221);
  display: block;
}
span.run31 {
  background-color: rgb(178, 255, 219);
  display: block;
}
span.run32 {
  background-color: rgb(178, 255, 216);
  display: block;
}
span.run33 {
  background-color: rgb(178, 255, 214);
  display: block;
}
span.run34 {
  background-color: rgb(178, 255, 211);
  display: block;
}
span.run35 {
  background-color: rgb(178, 255, 207);
  display: block;
}
span.run36 {
  background-color: rgb(178, 255, 205);
  display: block;
}
span.run37 {
  background-color: rgb(178, 255, 202);
  display: block;
}
span.run38 {
  background-color: rgb(178, 255, 200);
  display: block;
}
span.run39 {
  background-color: rgb(178, 255, 197);
  display: block;
}
span.run40 {
  background-color: rgb(178, 255, 193);
  display: block;
}
span.run41 {
  background-color: rgb(178, 255, 191);
  display: block;
}
span.run42 {
  background-color: rgb(178, 255, 188);
  display: block;
}
span.run43 {
  background-color: rgb(178, 255, 186);
  display: block;
}
span.run44 {
  background-color: rgb(178, 255, 183);
  display: block;
}
span.run45 {
  background-color: rgb(178, 255, 179);
  display: block;
}
span.run46 {
  background-color: rgb(179, 255, 178);
  display: block;
}
span.run47 {
  background-color: rgb(182, 255, 178);
  display: block;
}
span.run48 {
  background-color: rgb(184, 255, 178);
  display: block;
}
span.run49 {
  background-color: rgb(187, 255, 178);
  display: block;
}
span.run50 {
  background-color: rgb(191, 255, 178);
  display: block;
}
span.run51 {
  background-color: rgb(193, 255, 178);
  display: block;
}
span.run52 {
  background-color: rgb(196, 255, 178);
  display: block;
}
span.run53 {
  background-color: rgb(198, 255, 178);
  display: block;
}
span.run54 {
  background-color: rgb(201, 255, 178);
  display: block;
}
span.run55 {
  background-color: rgb(205, 255, 178);
  display: block;
}
span.run56 {
  background-color: rgb(207, 255, 178);
  display: block;
}
span.run57 {
  background-color: rgb(210, 255, 178);
  display: block;
}
span.run58 {
  background-color: rgb(212, 255, 178);
  display: block;
}
span.run59 {
  background-color: rgb(215, 255, 178);
  display: block;
}
span.run60 {
  background-color: rgb(219, 255, 178);
  display: block;
}
span.run61 {
  background-color: rgb(221, 255, 178);
  display: block;
}
span.run62 {
  background-color: rgb(224, 255, 178);
  display: block;
}
span.run63 {
  background-color: rgb(226, 255, 178);
  display: block;
}
span.run64 {
  background-color: rgb(229, 255, 178);
  display: block;
}
span.run65 {
  background-color: rgb(233, 255, 178);
  display: block;
}
span.run66 {
  background-color: rgb(235, 255, 178);
  display: block;
}
span.run67 {
  background-color: rgb(238, 255, 178);
  display: block;
}
span.run68 {
  background-color: rgb(240, 255, 178);
  display: block;
}
span.run69 {
  background-color: rgb(243, 255, 178);
  display: block;
}
span.run70 {
  background-color: rgb(247, 255, 178);
  display: block;
}
span.run71 {
  background-color: rgb(249, 255, 178);
  display: block;
}
span.run72 {
  background-color: rgb(252, 255, 178);
  display: block;
}
span.run73 {
  background-color: rgb(255, 255, 178);
  display: block;
}
span.run74 {
  background-color: rgb(255, 252, 178);
  display: block;
}
span.run75 {
  background-color: rgb(255, 248, 178);
  display: block;
}
span.run76 {
  background-color: rgb(255, 246, 178);
  display: block;
}
span.run77 {
  background-color: rgb(255, 243, 178);
  display: block;
}
span.run78 {
  background-color: rgb(255, 240, 178);
  display: block;
}
span.run79 {
  background-color: rgb(255, 238, 178);
  display: block;
}
span.run80 {
  background-color: rgb(255, 234, 178);
  display: block;
}
span.run81 {
  background-color: rgb(255, 232, 178);
  display: block;
}
span.run82 {
  background-color: rgb(255, 229, 178);
  display: block;
}
span.run83 {
  background-color: rgb(255, 226, 178);
  display: block;
}
span.run84 {
  background-color: rgb(255, 224, 178);
  display: block;
}
span.run85 {
  background-color: rgb(255, 220, 178);
  display: block;
}
span.run86 {
  background-color: rgb(255, 218, 178);
  display: block;
}
span.run87 {
  background-color: rgb(255, 215, 178);
  display: block;
}
span.run88 {
  background-color: rgb(255, 212, 178);
  display: block;
}
span.run89 {
  background-color: rgb(255, 210, 178);
  display: block;
}
span.run90 {
  background-color: rgb(255, 206, 178);
  display: block;
}
span.run91 {
  background-color: rgb(255, 204, 178);
  display: block;
}
span.run92 {
  background-color: rgb(255, 201, 178);
  display: block;
}
span.run93 {
  background-color: rgb(255, 198, 178);
  display: block;
}
span.run94 {
  background-color: rgb(255, 196, 178);
  display: block;
}
span.run95 {
  background-color: rgb(255, 192, 178);
  display: block;
}
span.run96 {
  background-color: rgb(255, 189, 178);
  display: block;
}
span.run97 {
  background-color: rgb(255, 187, 178);
  display: block;
}
span.run98 {
  background-color: rgb(255, 184, 178);
  display: block;
}
span.run99 {
  background-color: rgb(255, 182, 178);
  display: block;
}
span.run100 {
  background-color: rgb(255, 178, 178);
  display: block;
}
</style>
    </head>
  <body><h3>C0 code coverage information</h3>
    <p>Generated on Sun Apr 13 10:54:44 -0300 2008 with <a href='http://eigenclass.org/hiki/rcov'>rcov 0.8.1.2</a>
      </p>
    <hr/>
    <pre><span class='marked0'>Code reported as executed by Ruby looks like this...
</span><span class='marked1'>and this: this line is also marked as covered.
</span><span class='inferred0'>Lines considered as run by rcov, but not reported by Ruby, look like this,
</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).
</span><span class='uncovered0'>Finally, here&apos;s a line marked as not executed.
</span></pre>                       
<table class='report'><thead><tr><td class='heading'>Name</td>
      <td class='heading'>Total lines</td>
      <td class='heading'>Lines of code</td>
      <td class='heading'>Total coverage</td>
      <td class='heading'>Code coverage</td>
      </tr>
    </thead>
  <tbody><tr class='light'><td><a href='-var-lib-gems-1_8-gems-RedCloth-3_0_4-lib-redcloth_rb.html'>/var/lib/gems/1.8/gems/RedCloth-3.0.4/lib/redcloth.rb</a>
        </td>
      <td class='lines_total'><tt>1130</tt>
        </td>
      <td class='lines_code'><tt>720</tt>
        </td>
      <td><table cellspacing='0' cellpadding='0' align='right'><tr><td><tt class='coverage_total'>48.8%</tt>
              &nbsp;</td>
            <td><table cellspacing='0' class='percent_graph' cellpadding='0' width='100'><tr><td class='covered' width='49'/>
                  <td class='uncovered' width='51'/>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
      <td><table cellspacing='0' cellpadding='0' align='right'><tr><td><tt class='coverage_code'>28.9%</tt>
              &nbsp;</td>
            <td><table cellspacing='0' class='percent_graph' cellpadding='0' width='100'><tr><td class='covered' width='29'/>
                  <td class='uncovered' width='71'/>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
<pre><span class="inferred1"><a name="line1"></a>   1 #                                vim:ts=4:sw=4:
</span><span class="inferred0"><a name="line2"></a>   2 # = RedCloth - Textile and Markdown Hybrid for Ruby
</span><span class="inferred1"><a name="line3"></a>   3 #
</span><span class="inferred0"><a name="line4"></a>   4 # Homepage::  http://whytheluckystiff.net/ruby/redcloth/
</span><span class="inferred1"><a name="line5"></a>   5 # Author::    why the lucky stiff (http://whytheluckystiff.net/)
</span><span class="inferred0"><a name="line6"></a>   6 # Copyright:: (cc) 2004 why the lucky stiff (and his puppet organizations.)
</span><span class="inferred1"><a name="line7"></a>   7 # License::   BSD
</span><span class="inferred0"><a name="line8"></a>   8 #
</span><span class="inferred1"><a name="line9"></a>   9 # (see http://hobix.com/textile/ for a Textile Reference.)
</span><span class="inferred0"><a name="line10"></a>  10 #
</span><span class="inferred1"><a name="line11"></a>  11 # Based on (and also inspired by) both:
</span><span class="inferred0"><a name="line12"></a>  12 #
</span><span class="inferred1"><a name="line13"></a>  13 # PyTextile: http://diveintomark.org/projects/textile/textile.py.txt
</span><span class="inferred0"><a name="line14"></a>  14 # Textism for PHP: http://www.textism.com/tools/textile/
</span><span class="inferred1"><a name="line15"></a>  15 #
</span><span class="inferred0"><a name="line16"></a>  16 #
</span><span class="inferred1"><a name="line17"></a>  17 
</span><span class="inferred0"><a name="line18"></a>  18 # = RedCloth
</span><span class="inferred1"><a name="line19"></a>  19 #
</span><span class="inferred0"><a name="line20"></a>  20 # RedCloth is a Ruby library for converting Textile and/or Markdown
</span><span class="inferred1"><a name="line21"></a>  21 # into HTML.  You can use either format, intermingled or separately.
</span><span class="inferred0"><a name="line22"></a>  22 # You can also extend RedCloth to honor your own custom text stylings.
</span><span class="inferred1"><a name="line23"></a>  23 #
</span><span class="inferred0"><a name="line24"></a>  24 # RedCloth users are encouraged to use Textile if they are generating
</span><span class="inferred1"><a name="line25"></a>  25 # HTML and to use Markdown if others will be viewing the plain text.
</span><span class="inferred0"><a name="line26"></a>  26 #
</span><span class="inferred1"><a name="line27"></a>  27 # == What is Textile?
</span><span class="inferred0"><a name="line28"></a>  28 #
</span><span class="inferred1"><a name="line29"></a>  29 # Textile is a simple formatting style for text
</span><span class="inferred0"><a name="line30"></a>  30 # documents, loosely based on some HTML conventions.
</span><span class="inferred1"><a name="line31"></a>  31 #
</span><span class="inferred0"><a name="line32"></a>  32 # == Sample Textile Text
</span><span class="inferred1"><a name="line33"></a>  33 #
</span><span class="inferred0"><a name="line34"></a>  34 #  h2. This is a title
</span><span class="inferred1"><a name="line35"></a>  35 #
</span><span class="inferred0"><a name="line36"></a>  36 #  h3. This is a subhead
</span><span class="inferred1"><a name="line37"></a>  37 #
</span><span class="inferred0"><a name="line38"></a>  38 #  This is a bit of paragraph.
</span><span class="inferred1"><a name="line39"></a>  39 #
</span><span class="inferred0"><a name="line40"></a>  40 #  bq. This is a blockquote.
</span><span class="inferred1"><a name="line41"></a>  41 #
</span><span class="inferred0"><a name="line42"></a>  42 # = Writing Textile
</span><span class="inferred1"><a name="line43"></a>  43 #
</span><span class="inferred0"><a name="line44"></a>  44 # A Textile document consists of paragraphs.  Paragraphs
</span><span class="inferred1"><a name="line45"></a>  45 # can be specially formatted by adding a small instruction
</span><span class="inferred0"><a name="line46"></a>  46 # to the beginning of the paragraph.
</span><span class="inferred1"><a name="line47"></a>  47 #
</span><span class="inferred0"><a name="line48"></a>  48 #  h[n].   Header of size [n].
</span><span class="inferred1"><a name="line49"></a>  49 #  bq.     Blockquote.
</span><span class="inferred0"><a name="line50"></a>  50 #  #       Numeric list.
</span><span class="inferred1"><a name="line51"></a>  51 #  *       Bulleted list.
</span><span class="inferred0"><a name="line52"></a>  52 #
</span><span class="inferred1"><a name="line53"></a>  53 # == Quick Phrase Modifiers
</span><span class="inferred0"><a name="line54"></a>  54 #
</span><span class="inferred1"><a name="line55"></a>  55 # Quick phrase modifiers are also included, to allow formatting
</span><span class="inferred0"><a name="line56"></a>  56 # of small portions of text within a paragraph.
</span><span class="inferred1"><a name="line57"></a>  57 #
</span><span class="inferred0"><a name="line58"></a>  58 #  \_emphasis\_
</span><span class="inferred1"><a name="line59"></a>  59 #  \_\_italicized\_\_
</span><span class="inferred0"><a name="line60"></a>  60 #  \*strong\*
</span><span class="inferred1"><a name="line61"></a>  61 #  \*\*bold\*\*
</span><span class="inferred0"><a name="line62"></a>  62 #  ??citation??
</span><span class="inferred1"><a name="line63"></a>  63 #  -deleted text-
</span><span class="inferred0"><a name="line64"></a>  64 #  +inserted text+
</span><span class="inferred1"><a name="line65"></a>  65 #  ^superscript^
</span><span class="inferred0"><a name="line66"></a>  66 #  ~subscript~
</span><span class="inferred1"><a name="line67"></a>  67 #  @code@
</span><span class="inferred0"><a name="line68"></a>  68 #  %(classname)span%
</span><span class="inferred1"><a name="line69"></a>  69 #
</span><span class="inferred0"><a name="line70"></a>  70 #  ==notextile== (leave text alone)
</span><span class="inferred1"><a name="line71"></a>  71 #
</span><span class="inferred0"><a name="line72"></a>  72 # == Links
</span><span class="inferred1"><a name="line73"></a>  73 #
</span><span class="inferred0"><a name="line74"></a>  74 # To make a hypertext link, put the link text in &quot;quotation 
</span><span class="inferred1"><a name="line75"></a>  75 # marks&quot; followed immediately by a colon and the URL of the link.
</span><span class="inferred0"><a name="line76"></a>  76 # 
</span><span class="inferred1"><a name="line77"></a>  77 # Optional: text in (parentheses) following the link text, 
</span><span class="inferred0"><a name="line78"></a>  78 # but before the closing quotation mark, will become a Title 
</span><span class="inferred1"><a name="line79"></a>  79 # attribute for the link, visible as a tool tip when a cursor is above it.
</span><span class="inferred0"><a name="line80"></a>  80 # 
</span><span class="inferred1"><a name="line81"></a>  81 # Example:
</span><span class="inferred0"><a name="line82"></a>  82 #
</span><span class="inferred1"><a name="line83"></a>  83 #  &quot;This is a link (This is a title) &quot;:http://www.textism.com
</span><span class="inferred0"><a name="line84"></a>  84 # 
</span><span class="inferred1"><a name="line85"></a>  85 # Will become:
</span><span class="inferred0"><a name="line86"></a>  86 # 
</span><span class="inferred1"><a name="line87"></a>  87 #  &lt;a href=&quot;http://www.textism.com&quot; title=&quot;This is a title&quot;&gt;This is a link&lt;/a&gt;
</span><span class="inferred0"><a name="line88"></a>  88 #
</span><span class="inferred1"><a name="line89"></a>  89 # == Images
</span><span class="inferred0"><a name="line90"></a>  90 #
</span><span class="inferred1"><a name="line91"></a>  91 # To insert an image, put the URL for the image inside exclamation marks.
</span><span class="inferred0"><a name="line92"></a>  92 #
</span><span class="inferred1"><a name="line93"></a>  93 # Optional: text that immediately follows the URL in (parentheses) will 
</span><span class="inferred0"><a name="line94"></a>  94 # be used as the Alt text for the image. Images on the web should always 
</span><span class="inferred1"><a name="line95"></a>  95 # have descriptive Alt text for the benefit of readers using non-graphical 
</span><span class="inferred0"><a name="line96"></a>  96 # browsers.
</span><span class="inferred1"><a name="line97"></a>  97 #
</span><span class="inferred0"><a name="line98"></a>  98 # Optional: place a colon followed by a URL immediately after the 
</span><span class="inferred1"><a name="line99"></a>  99 # closing ! to make the image into a link.
</span><span class="inferred0"><a name="line100"></a> 100 # 
</span><span class="inferred1"><a name="line101"></a> 101 # Example:
</span><span class="inferred0"><a name="line102"></a> 102 #
</span><span class="inferred1"><a name="line103"></a> 103 #  !http://www.textism.com/common/textist.gif(Textist)!
</span><span class="inferred0"><a name="line104"></a> 104 #
</span><span class="inferred1"><a name="line105"></a> 105 # Will become:
</span><span class="inferred0"><a name="line106"></a> 106 #
</span><span class="inferred1"><a name="line107"></a> 107 #  &lt;img src=&quot;http://www.textism.com/common/textist.gif&quot; alt=&quot;Textist&quot; /&gt;
</span><span class="inferred0"><a name="line108"></a> 108 #
</span><span class="inferred1"><a name="line109"></a> 109 # With a link:
</span><span class="inferred0"><a name="line110"></a> 110 #
</span><span class="inferred1"><a name="line111"></a> 111 #  !/common/textist.gif(Textist)!:http://textism.com
</span><span class="inferred0"><a name="line112"></a> 112 #
</span><span class="inferred1"><a name="line113"></a> 113 # Will become:
</span><span class="inferred0"><a name="line114"></a> 114 #
</span><span class="inferred1"><a name="line115"></a> 115 #  &lt;a href=&quot;http://textism.com&quot;&gt;&lt;img src=&quot;/common/textist.gif&quot; alt=&quot;Textist&quot; /&gt;&lt;/a&gt;
</span><span class="inferred0"><a name="line116"></a> 116 #
</span><span class="inferred1"><a name="line117"></a> 117 # == Defining Acronyms
</span><span class="inferred0"><a name="line118"></a> 118 #
</span><span class="inferred1"><a name="line119"></a> 119 # HTML allows authors to define acronyms via the tag. The definition appears as a 
</span><span class="inferred0"><a name="line120"></a> 120 # tool tip when a cursor hovers over the acronym. A crucial aid to clear writing, 
</span><span class="inferred1"><a name="line121"></a> 121 # this should be used at least once for each acronym in documents where they appear.
</span><span class="inferred0"><a name="line122"></a> 122 #
</span><span class="inferred1"><a name="line123"></a> 123 # To quickly define an acronym in Textile, place the full text in (parentheses) 
</span><span class="inferred0"><a name="line124"></a> 124 # immediately following the acronym.
</span><span class="inferred1"><a name="line125"></a> 125 # 
</span><span class="inferred0"><a name="line126"></a> 126 # Example:
</span><span class="inferred1"><a name="line127"></a> 127 #
</span><span class="inferred0"><a name="line128"></a> 128 #  ACLU(American Civil Liberties Union)
</span><span class="inferred1"><a name="line129"></a> 129 #
</span><span class="inferred0"><a name="line130"></a> 130 # Will become:
</span><span class="inferred1"><a name="line131"></a> 131 #
</span><span class="inferred0"><a name="line132"></a> 132 #  &lt;acronym title=&quot;American Civil Liberties Union&quot;&gt;ACLU&lt;/acronym&gt;
</span><span class="inferred1"><a name="line133"></a> 133 #
</span><span class="inferred0"><a name="line134"></a> 134 # == Adding Tables
</span><span class="inferred1"><a name="line135"></a> 135 #
</span><span class="inferred0"><a name="line136"></a> 136 # In Textile, simple tables can be added by seperating each column by
</span><span class="inferred1"><a name="line137"></a> 137 # a pipe.
</span><span class="inferred0"><a name="line138"></a> 138 #
</span><span class="inferred1"><a name="line139"></a> 139 #     |a|simple|table|row|
</span><span class="inferred0"><a name="line140"></a> 140 #     |And|Another|table|row|
</span><span class="inferred1"><a name="line141"></a> 141 #
</span><span class="inferred0"><a name="line142"></a> 142 # Attributes are defined by style definitions in parentheses.
</span><span class="inferred1"><a name="line143"></a> 143 #
</span><span class="inferred0"><a name="line144"></a> 144 #     table(border:1px solid black).
</span><span class="inferred1"><a name="line145"></a> 145 #     (background:#ddd;color:red). |{}| | | |
</span><span class="inferred0"><a name="line146"></a> 146 #
</span><span class="inferred1"><a name="line147"></a> 147 # == Using RedCloth
</span><span class="inferred0"><a name="line148"></a> 148 # 
</span><span class="inferred1"><a name="line149"></a> 149 # RedCloth is simply an extension of the String class, which can handle
</span><span class="inferred0"><a name="line150"></a> 150 # Textile formatting.  Use it like a String and output HTML with its
</span><span class="inferred1"><a name="line151"></a> 151 # RedCloth#to_html method.
</span><span class="inferred0"><a name="line152"></a> 152 #
</span><span class="inferred1"><a name="line153"></a> 153 #  doc = RedCloth.new &quot;
</span><span class="inferred0"><a name="line154"></a> 154 #
</span><span class="inferred1"><a name="line155"></a> 155 #  h2. Test document
</span><span class="inferred0"><a name="line156"></a> 156 #
</span><span class="inferred1"><a name="line157"></a> 157 #  Just a simple test.&quot;
</span><span class="inferred0"><a name="line158"></a> 158 #
</span><span class="inferred1"><a name="line159"></a> 159 #  puts doc.to_html
</span><span class="inferred0"><a name="line160"></a> 160 #
</span><span class="inferred1"><a name="line161"></a> 161 # By default, RedCloth uses both Textile and Markdown formatting, with
</span><span class="inferred0"><a name="line162"></a> 162 # Textile formatting taking precedence.  If you want to turn off Markdown
</span><span class="inferred1"><a name="line163"></a> 163 # formatting, to boost speed and limit the processor:
</span><span class="inferred0"><a name="line164"></a> 164 #
</span><span class="inferred1"><a name="line165"></a> 165 #  class RedCloth::Textile.new( str )
</span><span class="inferred0"><a name="line166"></a> 166 
</span><span class="marked1"><a name="line167"></a> 167 class RedCloth &lt; String
</span><span class="inferred0"><a name="line168"></a> 168 
</span><span class="marked1"><a name="line169"></a> 169     VERSION = '3.0.4'
</span><span class="marked0"><a name="line170"></a> 170     DEFAULT_RULES = [:textile, :markdown]
</span><span class="inferred1"><a name="line171"></a> 171 
</span><span class="inferred0"><a name="line172"></a> 172     #
</span><span class="inferred1"><a name="line173"></a> 173     # Two accessor for setting security restrictions.
</span><span class="inferred0"><a name="line174"></a> 174     #
</span><span class="inferred1"><a name="line175"></a> 175     # This is a nice thing if you're using RedCloth for
</span><span class="inferred0"><a name="line176"></a> 176     # formatting in public places (e.g. Wikis) where you
</span><span class="inferred1"><a name="line177"></a> 177     # don't want users to abuse HTML for bad things.
</span><span class="inferred0"><a name="line178"></a> 178     #
</span><span class="inferred1"><a name="line179"></a> 179     # If +:filter_html+ is set, HTML which wasn't
</span><span class="inferred0"><a name="line180"></a> 180     # created by the Textile processor will be escaped.
</span><span class="inferred1"><a name="line181"></a> 181     #
</span><span class="inferred0"><a name="line182"></a> 182     # If +:filter_styles+ is set, it will also disable
</span><span class="inferred1"><a name="line183"></a> 183     # the style markup specifier. ('{color: red}')
</span><span class="inferred0"><a name="line184"></a> 184     #
</span><span class="marked1"><a name="line185"></a> 185     attr_accessor :filter_html, :filter_styles
</span><span class="inferred0"><a name="line186"></a> 186 
</span><span class="inferred1"><a name="line187"></a> 187     #
</span><span class="inferred0"><a name="line188"></a> 188     # Accessor for toggling hard breaks.
</span><span class="inferred1"><a name="line189"></a> 189     #
</span><span class="inferred0"><a name="line190"></a> 190     # If +:hard_breaks+ is set, single newlines will
</span><span class="inferred1"><a name="line191"></a> 191     # be converted to HTML break tags.  This is the
</span><span class="inferred0"><a name="line192"></a> 192     # default behavior for traditional RedCloth.
</span><span class="inferred1"><a name="line193"></a> 193     #
</span><span class="marked0"><a name="line194"></a> 194     attr_accessor :hard_breaks
</span><span class="inferred1"><a name="line195"></a> 195 
</span><span class="inferred0"><a name="line196"></a> 196     # Accessor for toggling lite mode.
</span><span class="inferred1"><a name="line197"></a> 197     #
</span><span class="inferred0"><a name="line198"></a> 198     # In lite mode, block-level rules are ignored.  This means
</span><span class="inferred1"><a name="line199"></a> 199     # that tables, paragraphs, lists, and such aren't available.
</span><span class="inferred0"><a name="line200"></a> 200     # Only the inline markup for bold, italics, entities and so on.
</span><span class="inferred1"><a name="line201"></a> 201     #
</span><span class="inferred0"><a name="line202"></a> 202     #   r = RedCloth.new( &quot;And then? She *fell*!&quot;, [:lite_mode] )
</span><span class="inferred1"><a name="line203"></a> 203     #   r.to_html
</span><span class="inferred0"><a name="line204"></a> 204     #   #=&gt; &quot;And then? She &lt;strong&gt;fell&lt;/strong&gt;!&quot;
</span><span class="inferred1"><a name="line205"></a> 205     #
</span><span class="marked0"><a name="line206"></a> 206     attr_accessor :lite_mode
</span><span class="inferred1"><a name="line207"></a> 207 
</span><span class="inferred0"><a name="line208"></a> 208     #
</span><span class="inferred1"><a name="line209"></a> 209     # Accessor for toggling span caps.
</span><span class="inferred0"><a name="line210"></a> 210     #
</span><span class="inferred1"><a name="line211"></a> 211     # Textile places `span' tags around capitalized
</span><span class="inferred0"><a name="line212"></a> 212     # words by default, but this wreaks havoc on Wikis.
</span><span class="inferred1"><a name="line213"></a> 213     # If +:no_span_caps+ is set, this will be
</span><span class="inferred0"><a name="line214"></a> 214     # suppressed.
</span><span class="inferred1"><a name="line215"></a> 215     #
</span><span class="marked0"><a name="line216"></a> 216     attr_accessor :no_span_caps
</span><span class="inferred1"><a name="line217"></a> 217 
</span><span class="inferred0"><a name="line218"></a> 218     #
</span><span class="inferred1"><a name="line219"></a> 219     # Establishes the markup predence.  Available rules include:
</span><span class="inferred0"><a name="line220"></a> 220     #
</span><span class="inferred1"><a name="line221"></a> 221     # == Textile Rules
</span><span class="inferred0"><a name="line222"></a> 222     #
</span><span class="inferred1"><a name="line223"></a> 223     # The following textile rules can be set individually.  Or add the complete
</span><span class="inferred0"><a name="line224"></a> 224     # set of rules with the single :textile rule, which supplies the rule set in
</span><span class="inferred1"><a name="line225"></a> 225     # the following precedence:
</span><span class="inferred0"><a name="line226"></a> 226     #
</span><span class="inferred1"><a name="line227"></a> 227     # refs_textile::          Textile references (i.e. [hobix]http://hobix.com/)
</span><span class="inferred0"><a name="line228"></a> 228     # block_textile_table::   Textile table block structures
</span><span class="inferred1"><a name="line229"></a> 229     # block_textile_lists::   Textile list structures
</span><span class="inferred0"><a name="line230"></a> 230     # block_textile_prefix::  Textile blocks with prefixes (i.e. bq., h2., etc.)
</span><span class="inferred1"><a name="line231"></a> 231     # inline_textile_image::  Textile inline images
</span><span class="inferred0"><a name="line232"></a> 232     # inline_textile_link::   Textile inline links
</span><span class="inferred1"><a name="line233"></a> 233     # inline_textile_span::   Textile inline spans
</span><span class="inferred0"><a name="line234"></a> 234     # glyphs_textile:: Textile entities (such as em-dashes and smart quotes)
</span><span class="inferred1"><a name="line235"></a> 235     #
</span><span class="inferred0"><a name="line236"></a> 236     # == Markdown
</span><span class="inferred1"><a name="line237"></a> 237     #
</span><span class="inferred0"><a name="line238"></a> 238     # refs_markdown::         Markdown references (for example: [hobix]: http://hobix.com/)
</span><span class="inferred1"><a name="line239"></a> 239     # block_markdown_setext:: Markdown setext headers
</span><span class="inferred0"><a name="line240"></a> 240     # block_markdown_atx::    Markdown atx headers
</span><span class="inferred1"><a name="line241"></a> 241     # block_markdown_rule::   Markdown horizontal rules
</span><span class="inferred0"><a name="line242"></a> 242     # block_markdown_bq::     Markdown blockquotes
</span><span class="inferred1"><a name="line243"></a> 243     # block_markdown_lists::  Markdown lists
</span><span class="inferred0"><a name="line244"></a> 244     # inline_markdown_link::  Markdown links
</span><span class="marked1"><a name="line245"></a> 245     attr_accessor :rules
</span><span class="inferred0"><a name="line246"></a> 246 
</span><span class="inferred1"><a name="line247"></a> 247     # Returns a new RedCloth object, based on _string_ and
</span><span class="inferred0"><a name="line248"></a> 248     # enforcing all the included _restrictions_.
</span><span class="inferred1"><a name="line249"></a> 249     #
</span><span class="inferred0"><a name="line250"></a> 250     #   r = RedCloth.new( &quot;h1. A &lt;b&gt;bold&lt;/b&gt; man&quot;, [:filter_html] )
</span><span class="inferred1"><a name="line251"></a> 251     #   r.to_html
</span><span class="inferred0"><a name="line252"></a> 252     #     #=&gt;&quot;&lt;h1&gt;A &amp;lt;b&amp;gt;bold&amp;lt;/b&amp;gt; man&lt;/h1&gt;&quot;
</span><span class="inferred1"><a name="line253"></a> 253     #
</span><span class="marked0"><a name="line254"></a> 254     def initialize( string, restrictions = [] )
</span><span class="uncovered1"><a name="line255"></a> 255         restrictions.each { |r| method( &quot;#{ r }=&quot; ).call( true ) }
</span><span class="uncovered0"><a name="line256"></a> 256         super( string )
</span><span class="uncovered1"><a name="line257"></a> 257     end
</span><span class="inferred0"><a name="line258"></a> 258 
</span><span class="inferred1"><a name="line259"></a> 259     #
</span><span class="inferred0"><a name="line260"></a> 260     # Generates HTML from the Textile contents.
</span><span class="inferred1"><a name="line261"></a> 261     #
</span><span class="inferred0"><a name="line262"></a> 262     #   r = RedCloth.new( &quot;And then? She *fell*!&quot; )
</span><span class="inferred1"><a name="line263"></a> 263     #   r.to_html( true )
</span><span class="inferred0"><a name="line264"></a> 264     #     #=&gt;&quot;And then? She &lt;strong&gt;fell&lt;/strong&gt;!&quot;
</span><span class="inferred1"><a name="line265"></a> 265     #
</span><span class="marked0"><a name="line266"></a> 266     def to_html( *rules )
</span><span class="uncovered1"><a name="line267"></a> 267         rules = DEFAULT_RULES if rules.empty?
</span><span class="uncovered0"><a name="line268"></a> 268         # make our working copy
</span><span class="uncovered1"><a name="line269"></a> 269         text = self.dup
</span><span class="uncovered0"><a name="line270"></a> 270         
</span><span class="uncovered1"><a name="line271"></a> 271         @urlrefs = {}
</span><span class="uncovered0"><a name="line272"></a> 272         @shelf = []
</span><span class="uncovered1"><a name="line273"></a> 273         textile_rules = [:refs_textile, :block_textile_table, :block_textile_lists,
</span><span class="uncovered0"><a name="line274"></a> 274                          :block_textile_prefix, :inline_textile_image, :inline_textile_link,
</span><span class="uncovered1"><a name="line275"></a> 275                          :inline_textile_code, :inline_textile_span, :glyphs_textile]
</span><span class="uncovered0"><a name="line276"></a> 276         markdown_rules = [:refs_markdown, :block_markdown_setext, :block_markdown_atx, :block_markdown_rule,
</span><span class="uncovered1"><a name="line277"></a> 277                           :block_markdown_bq, :block_markdown_lists, 
</span><span class="uncovered0"><a name="line278"></a> 278                           :inline_markdown_reflink, :inline_markdown_link]
</span><span class="uncovered1"><a name="line279"></a> 279         @rules = rules.collect do |rule|
</span><span class="uncovered0"><a name="line280"></a> 280             case rule
</span><span class="uncovered1"><a name="line281"></a> 281             when :markdown
</span><span class="uncovered0"><a name="line282"></a> 282                 markdown_rules
</span><span class="uncovered1"><a name="line283"></a> 283             when :textile
</span><span class="uncovered0"><a name="line284"></a> 284                 textile_rules
</span><span class="uncovered1"><a name="line285"></a> 285             else
</span><span class="uncovered0"><a name="line286"></a> 286                 rule
</span><span class="uncovered1"><a name="line287"></a> 287             end
</span><span class="uncovered0"><a name="line288"></a> 288         end.flatten
</span><span class="uncovered1"><a name="line289"></a> 289 
</span><span class="uncovered0"><a name="line290"></a> 290         # standard clean up
</span><span class="uncovered1"><a name="line291"></a> 291         incoming_entities text 
</span><span class="uncovered0"><a name="line292"></a> 292         clean_white_space text 
</span><span class="uncovered1"><a name="line293"></a> 293 
</span><span class="uncovered0"><a name="line294"></a> 294         # start processor
</span><span class="uncovered1"><a name="line295"></a> 295         @pre_list = []
</span><span class="uncovered0"><a name="line296"></a> 296         rip_offtags text
</span><span class="uncovered1"><a name="line297"></a> 297         no_textile text
</span><span class="uncovered0"><a name="line298"></a> 298         hard_break text 
</span><span class="uncovered1"><a name="line299"></a> 299         unless @lite_mode
</span><span class="uncovered0"><a name="line300"></a> 300             refs text
</span><span class="uncovered1"><a name="line301"></a> 301             blocks text
</span><span class="uncovered0"><a name="line302"></a> 302         end
</span><span class="uncovered1"><a name="line303"></a> 303         inline text
</span><span class="uncovered0"><a name="line304"></a> 304         smooth_offtags text
</span><span class="uncovered1"><a name="line305"></a> 305 
</span><span class="uncovered0"><a name="line306"></a> 306         retrieve text
</span><span class="uncovered1"><a name="line307"></a> 307 
</span><span class="uncovered0"><a name="line308"></a> 308         text.gsub!( /&lt;\/?notextile&gt;/, '' )
</span><span class="inferred1"><a name="line309"></a> 309         text.gsub!( /x%x%/, '&amp;#38;' )
</span><span class="inferred0"><a name="line310"></a> 310         clean_html text if filter_html
</span><span class="inferred1"><a name="line311"></a> 311         text.strip!
</span><span class="inferred0"><a name="line312"></a> 312         text
</span><span class="inferred1"><a name="line313"></a> 313 
</span><span class="inferred0"><a name="line314"></a> 314     end
</span><span class="inferred1"><a name="line315"></a> 315 
</span><span class="inferred0"><a name="line316"></a> 316     #######
</span><span class="marked1"><a name="line317"></a> 317     private
</span><span class="inferred0"><a name="line318"></a> 318     #######
</span><span class="inferred1"><a name="line319"></a> 319     #
</span><span class="inferred0"><a name="line320"></a> 320     # Mapping of 8-bit ASCII codes to HTML numerical entity equivalents.
</span><span class="inferred1"><a name="line321"></a> 321     # (from PyTextile)
</span><span class="inferred0"><a name="line322"></a> 322     #
</span><span class="marked1"><a name="line323"></a> 323     TEXTILE_TAGS =
</span><span class="inferred0"><a name="line324"></a> 324 
</span><span class="inferred1"><a name="line325"></a> 325         [[128, 8364], [129, 0], [130, 8218], [131, 402], [132, 8222], [133, 8230], 
</span><span class="inferred0"><a name="line326"></a> 326          [134, 8224], [135, 8225], [136, 710], [137, 8240], [138, 352], [139, 8249], 
</span><span class="inferred1"><a name="line327"></a> 327          [140, 338], [141, 0], [142, 0], [143, 0], [144, 0], [145, 8216], [146, 8217], 
</span><span class="inferred0"><a name="line328"></a> 328          [147, 8220], [148, 8221], [149, 8226], [150, 8211], [151, 8212], [152, 732], 
</span><span class="inferred1"><a name="line329"></a> 329          [153, 8482], [154, 353], [155, 8250], [156, 339], [157, 0], [158, 0], [159, 376]].
</span><span class="inferred0"><a name="line330"></a> 330 
</span><span class="inferred1"><a name="line331"></a> 331         collect! do |a, b|
</span><span class="marked0"><a name="line332"></a> 332             [a.chr, ( b.zero? and &quot;&quot; or &quot;&amp;#{ b };&quot; )]
</span><span class="inferred1"><a name="line333"></a> 333         end
</span><span class="inferred0"><a name="line334"></a> 334 
</span><span class="inferred1"><a name="line335"></a> 335     #
</span><span class="inferred0"><a name="line336"></a> 336     # Regular expressions to convert to HTML.
</span><span class="inferred1"><a name="line337"></a> 337     #
</span><span class="marked0"><a name="line338"></a> 338     A_HLGN = /(?:(?:&lt;&gt;|&lt;|&gt;|\=|[()]+)+)/
</span><span class="marked1"><a name="line339"></a> 339     A_VLGN = /[\-^~]/
</span><span class="marked0"><a name="line340"></a> 340     C_CLAS = '(?:\([^)]+\))'
</span><span class="marked1"><a name="line341"></a> 341     C_LNGE = '(?:\[[^\]]+\])'
</span><span class="marked0"><a name="line342"></a> 342     C_STYL = '(?:\{[^}]+\})'
</span><span class="marked1"><a name="line343"></a> 343     S_CSPN = '(?:\\\\\d+)'
</span><span class="marked0"><a name="line344"></a> 344     S_RSPN = '(?:/\d+)'
</span><span class="marked1"><a name="line345"></a> 345     A = &quot;(?:#{A_HLGN}?#{A_VLGN}?|#{A_VLGN}?#{A_HLGN}?)&quot;
</span><span class="marked0"><a name="line346"></a> 346     S = &quot;(?:#{S_CSPN}?#{S_RSPN}|#{S_RSPN}?#{S_CSPN}?)&quot;
</span><span class="marked1"><a name="line347"></a> 347     C = &quot;(?:#{C_CLAS}?#{C_STYL}?#{C_LNGE}?|#{C_STYL}?#{C_LNGE}?#{C_CLAS}?|#{C_LNGE}?#{C_STYL}?#{C_CLAS}?)&quot;
</span><span class="inferred0"><a name="line348"></a> 348     # PUNCT = Regexp::quote( '!&quot;#$%&amp;\'()*+,-./:;&lt;=&gt;?@[\\]^_`{|}~' )
</span><span class="marked1"><a name="line349"></a> 349     PUNCT = Regexp::quote( '!&quot;#$%&amp;\'*+,-./:;=?@\\^_`|~' )
</span><span class="marked0"><a name="line350"></a> 350     PUNCT_NOQ = Regexp::quote( '!&quot;#$&amp;\',./:;=?@\\`|' )
</span><span class="marked1"><a name="line351"></a> 351     PUNCT_Q = Regexp::quote( '*-_+^~%' )
</span><span class="marked0"><a name="line352"></a> 352     HYPERLINK = '(\S+?)([^\w\s/;=\?]*?)(?=\s|&lt;|$)'
</span><span class="inferred1"><a name="line353"></a> 353 
</span><span class="inferred0"><a name="line354"></a> 354     # Text markup tags, don't conflict with block tags
</span><span class="marked1"><a name="line355"></a> 355     SIMPLE_HTML_TAGS = [
</span><span class="inferred0"><a name="line356"></a> 356         'tt', 'b', 'i', 'big', 'small', 'em', 'strong', 'dfn', 'code', 
</span><span class="inferred1"><a name="line357"></a> 357         'samp', 'kbd', 'var', 'cite', 'abbr', 'acronym', 'a', 'img', 'br',
</span><span class="inferred0"><a name="line358"></a> 358         'br', 'map', 'q', 'sub', 'sup', 'span', 'bdo'
</span><span class="inferred1"><a name="line359"></a> 359     ]
</span><span class="inferred0"><a name="line360"></a> 360 
</span><span class="marked1"><a name="line361"></a> 361     QTAGS = [
</span><span class="inferred0"><a name="line362"></a> 362         ['**', 'b'],
</span><span class="inferred1"><a name="line363"></a> 363         ['*', 'strong'],
</span><span class="inferred0"><a name="line364"></a> 364         ['??', 'cite', :limit],
</span><span class="inferred1"><a name="line365"></a> 365         ['-', 'del', :limit],
</span><span class="inferred0"><a name="line366"></a> 366         ['__', 'i'],
</span><span class="inferred1"><a name="line367"></a> 367         ['_', 'em', :limit],
</span><span class="inferred0"><a name="line368"></a> 368         ['%', 'span', :limit],
</span><span class="inferred1"><a name="line369"></a> 369         ['+', 'ins', :limit],
</span><span class="inferred0"><a name="line370"></a> 370         ['^', 'sup'],
</span><span class="inferred1"><a name="line371"></a> 371         ['~', 'sub']
</span><span class="inferred0"><a name="line372"></a> 372     ] 
</span><span class="marked1"><a name="line373"></a> 373     QTAGS.collect! do |rc, ht, rtype|
</span><span class="marked0"><a name="line374"></a> 374         rcq = Regexp::quote rc
</span><span class="marked1"><a name="line375"></a> 375         re =
</span><span class="inferred0"><a name="line376"></a> 376             case rtype
</span><span class="marked1"><a name="line377"></a> 377             when :limit
</span><span class="uncovered0"><a name="line378"></a> 378                 /(\W)
</span><span class="marked1"><a name="line379"></a> 379                 (#{rcq})
</span><span class="uncovered0"><a name="line380"></a> 380                 (#{C})
</span><span class="uncovered1"><a name="line381"></a> 381                 (?::(\S+?))?
</span><span class="uncovered0"><a name="line382"></a> 382                 (\S.*?\S|\S)
</span><span class="uncovered1"><a name="line383"></a> 383                 #{rcq}
</span><span class="uncovered0"><a name="line384"></a> 384                 (?=\W)/x
</span><span class="inferred1"><a name="line385"></a> 385             else
</span><span class="marked0"><a name="line386"></a> 386                 /(#{rcq})
</span><span class="uncovered1"><a name="line387"></a> 387                 (#{C})
</span><span class="uncovered0"><a name="line388"></a> 388                 (?::(\S+))?
</span><span class="uncovered1"><a name="line389"></a> 389                 (\S.*?\S|\S)
</span><span class="uncovered0"><a name="line390"></a> 390                 #{rcq}/xm 
</span><span class="uncovered1"><a name="line391"></a> 391             end
</span><span class="marked0"><a name="line392"></a> 392         [rc, ht, re, rtype]
</span><span class="inferred1"><a name="line393"></a> 393     end
</span><span class="inferred0"><a name="line394"></a> 394 
</span><span class="inferred1"><a name="line395"></a> 395     # Elements to handle
</span><span class="marked0"><a name="line396"></a> 396     GLYPHS = [
</span><span class="inferred1"><a name="line397"></a> 397     #   [ /([^\s\[{(&gt;])?\'([dmst]\b|ll\b|ve\b|\s|:|$)/, '\1&amp;#8217;\2' ], # single closing
</span><span class="inferred0"><a name="line398"></a> 398         [ /([^\s\[{(&gt;#{PUNCT_Q}][#{PUNCT_Q}]*)\'/, '\1&amp;#8217;' ], # single closing
</span><span class="inferred1"><a name="line399"></a> 399         [ /\'(?=[#{PUNCT_Q}]*(s\b|[\s#{PUNCT_NOQ}]))/, '&amp;#8217;' ], # single closing
</span><span class="inferred0"><a name="line400"></a> 400         [ /\'/, '&amp;#8216;' ], # single opening
</span><span class="inferred1"><a name="line401"></a> 401         [ /&lt;/, '&amp;lt;' ], # less-than
</span><span class="inferred0"><a name="line402"></a> 402         [ /&gt;/, '&amp;gt;' ], # greater-than
</span><span class="inferred1"><a name="line403"></a> 403     #   [ /([^\s\[{(])?&quot;(\s|:|$)/, '\1&amp;#8221;\2' ], # double closing
</span><span class="inferred0"><a name="line404"></a> 404         [ /([^\s\[{(&gt;#{PUNCT_Q}][#{PUNCT_Q}]*)&quot;/, '\1&amp;#8221;' ], # double closing
</span><span class="inferred1"><a name="line405"></a> 405         [ /&quot;(?=[#{PUNCT_Q}]*[\s#{PUNCT_NOQ}])/, '&amp;#8221;' ], # double closing
</span><span class="inferred0"><a name="line406"></a> 406         [ /&quot;/, '&amp;#8220;' ], # double opening
</span><span class="inferred1"><a name="line407"></a> 407         [ /\b( )?\.{3}/, '\1&amp;#8230;' ], # ellipsis
</span><span class="inferred0"><a name="line408"></a> 408         [ /\b([A-Z][A-Z0-9]{2,})\b(?:[(]([^)]*)[)])/, '&lt;acronym title=&quot;\2&quot;&gt;\1&lt;/acronym&gt;' ], # 3+ uppercase acronym
</span><span class="inferred1"><a name="line409"></a> 409         [ /(^|[^&quot;][&gt;\s])([A-Z][A-Z0-9 ]+[A-Z0-9])([^&lt;A-Za-z0-9]|$)/, '\1&lt;span class=&quot;caps&quot;&gt;\2&lt;/span&gt;\3', :no_span_caps ], # 3+ uppercase caps
</span><span class="inferred0"><a name="line410"></a> 410         [ /(\.\s)?\s?--\s?/, '\1&amp;#8212;' ], # em dash
</span><span class="inferred1"><a name="line411"></a> 411         [ /\s-&gt;\s/, ' &amp;rarr; ' ], # right arrow
</span><span class="inferred0"><a name="line412"></a> 412         [ /\s-\s/, ' &amp;#8211; ' ], # en dash
</span><span class="inferred1"><a name="line413"></a> 413         [ /(\d+) ?x ?(\d+)/, '\1&amp;#215;\2' ], # dimension sign
</span><span class="inferred0"><a name="line414"></a> 414         [ /\b ?[(\[]TM[\])]/i, '&amp;#8482;' ], # trademark
</span><span class="inferred1"><a name="line415"></a> 415         [ /\b ?[(\[]R[\])]/i, '&amp;#174;' ], # registered
</span><span class="inferred0"><a name="line416"></a> 416         [ /\b ?[(\[]C[\])]/i, '&amp;#169;' ] # copyright
</span><span class="inferred1"><a name="line417"></a> 417     ]
</span><span class="inferred0"><a name="line418"></a> 418 
</span><span class="marked1"><a name="line419"></a> 419     H_ALGN_VALS = {
</span><span class="inferred0"><a name="line420"></a> 420         '&lt;' =&gt; 'left',
</span><span class="inferred1"><a name="line421"></a> 421         '=' =&gt; 'center',
</span><span class="inferred0"><a name="line422"></a> 422         '&gt;' =&gt; 'right',
</span><span class="inferred1"><a name="line423"></a> 423         '&lt;&gt;' =&gt; 'justify'
</span><span class="inferred0"><a name="line424"></a> 424     }
</span><span class="inferred1"><a name="line425"></a> 425 
</span><span class="marked0"><a name="line426"></a> 426     V_ALGN_VALS = {
</span><span class="inferred1"><a name="line427"></a> 427         '^' =&gt; 'top',
</span><span class="inferred0"><a name="line428"></a> 428         '-' =&gt; 'middle',
</span><span class="inferred1"><a name="line429"></a> 429         '~' =&gt; 'bottom'
</span><span class="inferred0"><a name="line430"></a> 430     }
</span><span class="inferred1"><a name="line431"></a> 431 
</span><span class="inferred0"><a name="line432"></a> 432     #
</span><span class="inferred1"><a name="line433"></a> 433     # Flexible HTML escaping
</span><span class="inferred0"><a name="line434"></a> 434     #
</span><span class="marked1"><a name="line435"></a> 435     def htmlesc( str, mode )
</span><span class="uncovered0"><a name="line436"></a> 436         str.gsub!( '&amp;', '&amp;amp;' )
</span><span class="uncovered1"><a name="line437"></a> 437         str.gsub!( '&quot;', '&amp;quot;' ) if mode != :NoQuotes
</span><span class="uncovered0"><a name="line438"></a> 438         str.gsub!( &quot;'&quot;, '&amp;#039;' ) if mode == :Quotes
</span><span class="uncovered1"><a name="line439"></a> 439         str.gsub!( '&lt;', '&amp;lt;')
</span><span class="uncovered0"><a name="line440"></a> 440         str.gsub!( '&gt;', '&amp;gt;')
</span><span class="uncovered1"><a name="line441"></a> 441     end
</span><span class="inferred0"><a name="line442"></a> 442 
</span><span class="inferred1"><a name="line443"></a> 443     # Search and replace for Textile glyphs (quotes, dashes, other symbols)
</span><span class="marked0"><a name="line444"></a> 444     def pgl( text )
</span><span class="uncovered1"><a name="line445"></a> 445         GLYPHS.each do |re, resub, tog|
</span><span class="uncovered0"><a name="line446"></a> 446             next if tog and method( tog ).call
</span><span class="uncovered1"><a name="line447"></a> 447             text.gsub! re, resub
</span><span class="uncovered0"><a name="line448"></a> 448         end
</span><span class="uncovered1"><a name="line449"></a> 449     end
</span><span class="inferred0"><a name="line450"></a> 450 
</span><span class="inferred1"><a name="line451"></a> 451     # Parses Textile attribute lists and builds an HTML attribute string
</span><span class="marked0"><a name="line452"></a> 452     def pba( text_in, element = &quot;&quot; )
</span><span class="uncovered1"><a name="line453"></a> 453         
</span><span class="uncovered0"><a name="line454"></a> 454         return '' unless text_in
</span><span class="uncovered1"><a name="line455"></a> 455 
</span><span class="uncovered0"><a name="line456"></a> 456         style = []
</span><span class="uncovered1"><a name="line457"></a> 457         text = text_in.dup
</span><span class="uncovered0"><a name="line458"></a> 458         if element == 'td'
</span><span class="uncovered1"><a name="line459"></a> 459             colspan = $1 if text =~ /\\(\d+)/
</span><span class="uncovered0"><a name="line460"></a> 460             rowspan = $1 if text =~ /\/(\d+)/
</span><span class="uncovered1"><a name="line461"></a> 461             style &lt;&lt; &quot;vertical-align:#{ v_align( $&amp; ) };&quot; if text =~ A_VLGN
</span><span class="uncovered0"><a name="line462"></a> 462         end
</span><span class="uncovered1"><a name="line463"></a> 463 
</span><span class="uncovered0"><a name="line464"></a> 464         style &lt;&lt; &quot;#{ $1 };&quot; if not filter_styles and
</span><span class="uncovered1"><a name="line465"></a> 465             text.sub!( /\{([^}]*)\}/, '' )
</span><span class="uncovered0"><a name="line466"></a> 466 
</span><span class="uncovered1"><a name="line467"></a> 467         lang = $1 if
</span><span class="uncovered0"><a name="line468"></a> 468             text.sub!( /\[([^)]+?)\]/, '' )
</span><span class="uncovered1"><a name="line469"></a> 469 
</span><span class="uncovered0"><a name="line470"></a> 470         cls = $1 if
</span><span class="uncovered1"><a name="line471"></a> 471             text.sub!( /\(([^()]+?)\)/, '' )
</span><span class="uncovered0"><a name="line472"></a> 472                         
</span><span class="uncovered1"><a name="line473"></a> 473         style &lt;&lt; &quot;padding-left:#{ $1.length }em;&quot; if
</span><span class="uncovered0"><a name="line474"></a> 474             text.sub!( /([(]+)/, '' )
</span><span class="uncovered1"><a name="line475"></a> 475 
</span><span class="uncovered0"><a name="line476"></a> 476         style &lt;&lt; &quot;padding-right:#{ $1.length }em;&quot; if text.sub!( /([)]+)/, '' )
</span><span class="uncovered1"><a name="line477"></a> 477 
</span><span class="uncovered0"><a name="line478"></a> 478         style &lt;&lt; &quot;text-align:#{ h_align( $&amp; ) };&quot; if text =~ A_HLGN
</span><span class="uncovered1"><a name="line479"></a> 479 
</span><span class="uncovered0"><a name="line480"></a> 480         cls, id = $1, $2 if cls =~ /^(.*?)#(.*)$/
</span><span class="uncovered1"><a name="line481"></a> 481         
</span><span class="uncovered0"><a name="line482"></a> 482         atts = ''
</span><span class="uncovered1"><a name="line483"></a> 483         atts &lt;&lt; &quot; style=\&quot;#{ style.join }\&quot;&quot; unless style.empty?
</span><span class="uncovered0"><a name="line484"></a> 484         atts &lt;&lt; &quot; class=\&quot;#{ cls }\&quot;&quot; unless cls.to_s.empty?
</span><span class="uncovered1"><a name="line485"></a> 485         atts &lt;&lt; &quot; lang=\&quot;#{ lang }\&quot;&quot; if lang
</span><span class="uncovered0"><a name="line486"></a> 486         atts &lt;&lt; &quot; id=\&quot;#{ id }\&quot;&quot; if id
</span><span class="uncovered1"><a name="line487"></a> 487         atts &lt;&lt; &quot; colspan=\&quot;#{ colspan }\&quot;&quot; if colspan
</span><span class="uncovered0"><a name="line488"></a> 488         atts &lt;&lt; &quot; rowspan=\&quot;#{ rowspan }\&quot;&quot; if rowspan
</span><span class="uncovered1"><a name="line489"></a> 489         
</span><span class="uncovered0"><a name="line490"></a> 490         atts
</span><span class="uncovered1"><a name="line491"></a> 491     end
</span><span class="inferred0"><a name="line492"></a> 492 
</span><span class="marked1"><a name="line493"></a> 493     TABLE_RE = /^(?:table(_?#{S}#{A}#{C})\. ?\n)?^(#{A}#{C}\.? ?\|.*?\|)(\n\n|\Z)/m
</span><span class="inferred0"><a name="line494"></a> 494     
</span><span class="inferred1"><a name="line495"></a> 495     # Parses a Textile table block, building HTML from the result.
</span><span class="marked0"><a name="line496"></a> 496     def block_textile_table( text ) 
</span><span class="uncovered1"><a name="line497"></a> 497         text.gsub!( TABLE_RE ) do |matches|
</span><span class="uncovered0"><a name="line498"></a> 498 
</span><span class="uncovered1"><a name="line499"></a> 499             tatts, fullrow = $~[1..2]
</span><span class="uncovered0"><a name="line500"></a> 500             tatts = pba( tatts, 'table' )
</span><span class="uncovered1"><a name="line501"></a> 501             tatts = shelve( tatts ) if tatts
</span><span class="uncovered0"><a name="line502"></a> 502             rows = []
</span><span class="uncovered1"><a name="line503"></a> 503 
</span><span class="uncovered0"><a name="line504"></a> 504             fullrow.
</span><span class="uncovered1"><a name="line505"></a> 505             split( /\|$/m ).
</span><span class="uncovered0"><a name="line506"></a> 506             delete_if { |x| x.empty? }.
</span><span class="uncovered1"><a name="line507"></a> 507             each do |row|
</span><span class="uncovered0"><a name="line508"></a> 508 
</span><span class="uncovered1"><a name="line509"></a> 509                 ratts, row = pba( $1, 'tr' ), $2 if row =~ /^(#{A}#{C}\. )(.*)/m
</span><span class="uncovered0"><a name="line510"></a> 510                 
</span><span class="uncovered1"><a name="line511"></a> 511                 cells = []
</span><span class="uncovered0"><a name="line512"></a> 512                 row.split( '|' ).each do |cell|
</span><span class="uncovered1"><a name="line513"></a> 513                     ctyp = 'd'
</span><span class="uncovered0"><a name="line514"></a> 514                     ctyp = 'h' if cell =~ /^_/
</span><span class="uncovered1"><a name="line515"></a> 515 
</span><span class="uncovered0"><a name="line516"></a> 516                     catts = ''
</span><span class="uncovered1"><a name="line517"></a> 517                     catts, cell = pba( $1, 'td' ), $2 if cell =~ /^(_?#{S}#{A}#{C}\. ?)(.*)/
</span><span class="uncovered0"><a name="line518"></a> 518 
</span><span class="uncovered1"><a name="line519"></a> 519                     unless cell.strip.empty?
</span><span class="uncovered0"><a name="line520"></a> 520                         catts = shelve( catts ) if catts
</span><span class="uncovered1"><a name="line521"></a> 521                         cells &lt;&lt; &quot;\t\t\t&lt;t#{ ctyp }#{ catts }&gt;#{ cell }&lt;/t#{ ctyp }&gt;&quot; 
</span><span class="uncovered0"><a name="line522"></a> 522                     end
</span><span class="uncovered1"><a name="line523"></a> 523                 end
</span><span class="uncovered0"><a name="line524"></a> 524                 ratts = shelve( ratts ) if ratts
</span><span class="uncovered1"><a name="line525"></a> 525                 rows &lt;&lt; &quot;\t\t&lt;tr#{ ratts }&gt;\n#{ cells.join( &quot;\n&quot; ) }\n\t\t&lt;/tr&gt;&quot;
</span><span class="uncovered0"><a name="line526"></a> 526             end
</span><span class="uncovered1"><a name="line527"></a> 527             &quot;\t&lt;table#{ tatts }&gt;\n#{ rows.join( &quot;\n&quot; ) }\n\t&lt;/table&gt;\n\n&quot;
</span><span class="uncovered0"><a name="line528"></a> 528         end
</span><span class="uncovered1"><a name="line529"></a> 529     end
</span><span class="inferred0"><a name="line530"></a> 530 
</span><span class="marked1"><a name="line531"></a> 531     LISTS_RE = /^([#*]+?#{C} .*?)$(?![^#*])/m
</span><span class="marked0"><a name="line532"></a> 532     LISTS_CONTENT_RE = /^([#*]+)(#{A}#{C}) (.*)$/m
</span><span class="inferred1"><a name="line533"></a> 533 
</span><span class="inferred0"><a name="line534"></a> 534     # Parses Textile lists and generates HTML
</span><span class="marked1"><a name="line535"></a> 535     def block_textile_lists( text ) 
</span><span class="uncovered0"><a name="line536"></a> 536         text.gsub!( LISTS_RE ) do |match|
</span><span class="uncovered1"><a name="line537"></a> 537             lines = match.split( /\n/ )
</span><span class="uncovered0"><a name="line538"></a> 538             last_line = -1
</span><span class="uncovered1"><a name="line539"></a> 539             depth = []
</span><span class="uncovered0"><a name="line540"></a> 540             lines.each_with_index do |line, line_id|
</span><span class="uncovered1"><a name="line541"></a> 541                 if line =~ LISTS_CONTENT_RE 
</span><span class="uncovered0"><a name="line542"></a> 542                     tl,atts,content = $~[1..3]
</span><span class="uncovered1"><a name="line543"></a> 543                     if depth.last
</span><span class="uncovered0"><a name="line544"></a> 544                         if depth.last.length &gt; tl.length
</span><span class="uncovered1"><a name="line545"></a> 545                             (depth.length - 1).downto(0) do |i|
</span><span class="uncovered0"><a name="line546"></a> 546                                 break if depth[i].length == tl.length
</span><span class="uncovered1"><a name="line547"></a> 547                                 lines[line_id - 1] &lt;&lt; &quot;&lt;/li&gt;\n\t&lt;/#{ lT( depth[i] ) }l&gt;\n\t&quot;
</span><span class="uncovered0"><a name="line548"></a> 548                                 depth.pop
</span><span class="uncovered1"><a name="line549"></a> 549                             end
</span><span class="uncovered0"><a name="line550"></a> 550                         end
</span><span class="uncovered1"><a name="line551"></a> 551                         if depth.last and depth.last.length == tl.length
</span><span class="uncovered0"><a name="line552"></a> 552                             lines[line_id - 1] &lt;&lt; '&lt;/li&gt;'
</span><span class="uncovered1"><a name="line553"></a> 553                         end
</span><span class="uncovered0"><a name="line554"></a> 554                     end
</span><span class="uncovered1"><a name="line555"></a> 555                     unless depth.last == tl
</span><span class="uncovered0"><a name="line556"></a> 556                         depth &lt;&lt; tl
</span><span class="uncovered1"><a name="line557"></a> 557                         atts = pba( atts )
</span><span class="uncovered0"><a name="line558"></a> 558                         atts = shelve( atts ) if atts
</span><span class="uncovered1"><a name="line559"></a> 559                         lines[line_id] = &quot;\t&lt;#{ lT(tl) }l#{ atts }&gt;\n\t&lt;li&gt;#{ content }&quot;
</span><span class="uncovered0"><a name="line560"></a> 560                     else
</span><span class="uncovered1"><a name="line561"></a> 561                         lines[line_id] = &quot;\t\t&lt;li&gt;#{ content }&quot;
</span><span class="uncovered0"><a name="line562"></a> 562                     end
</span><span class="uncovered1"><a name="line563"></a> 563                     last_line = line_id
</span><span class="uncovered0"><a name="line564"></a> 564 
</span><span class="uncovered1"><a name="line565"></a> 565                 else
</span><span class="uncovered0"><a name="line566"></a> 566                     last_line = line_id
</span><span class="uncovered1"><a name="line567"></a> 567                 end
</span><span class="uncovered0"><a name="line568"></a> 568                 if line_id - last_line &gt; 1 or line_id == lines.length - 1
</span><span class="uncovered1"><a name="line569"></a> 569                     depth.delete_if do |v|
</span><span class="uncovered0"><a name="line570"></a> 570                         lines[last_line] &lt;&lt; &quot;&lt;/li&gt;\n\t&lt;/#{ lT( v ) }l&gt;&quot;
</span><span class="uncovered1"><a name="line571"></a> 571                     end
</span><span class="uncovered0"><a name="line572"></a> 572                 end
</span><span class="uncovered1"><a name="line573"></a> 573             end
</span><span class="uncovered0"><a name="line574"></a> 574             lines.join( &quot;\n&quot; )
</span><span class="uncovered1"><a name="line575"></a> 575         end
</span><span class="uncovered0"><a name="line576"></a> 576     end
</span><span class="inferred1"><a name="line577"></a> 577 
</span><span class="marked0"><a name="line578"></a> 578     CODE_RE = /(\W)
</span><span class="uncovered1"><a name="line579"></a> 579         @
</span><span class="uncovered0"><a name="line580"></a> 580         (?:\|(\w+?)\|)?
</span><span class="uncovered1"><a name="line581"></a> 581         (.+?)
</span><span class="uncovered0"><a name="line582"></a> 582         @
</span><span class="uncovered1"><a name="line583"></a> 583         (?=\W)/x
</span><span class="inferred0"><a name="line584"></a> 584 
</span><span class="marked1"><a name="line585"></a> 585     def inline_textile_code( text ) 
</span><span class="uncovered0"><a name="line586"></a> 586         text.gsub!( CODE_RE ) do |m|
</span><span class="uncovered1"><a name="line587"></a> 587             before,lang,code,after = $~[1..4]
</span><span class="uncovered0"><a name="line588"></a> 588             lang = &quot; lang=\&quot;#{ lang }\&quot;&quot; if lang
</span><span class="uncovered1"><a name="line589"></a> 589             rip_offtags( &quot;#{ before }&lt;code#{ lang }&gt;#{ code }&lt;/code&gt;#{ after }&quot; )
</span><span class="uncovered0"><a name="line590"></a> 590         end
</span><span class="uncovered1"><a name="line591"></a> 591     end
</span><span class="inferred0"><a name="line592"></a> 592 
</span><span class="marked1"><a name="line593"></a> 593     def lT( text ) 
</span><span class="uncovered0"><a name="line594"></a> 594         text =~ /\#$/ ? 'o' : 'u'
</span><span class="uncovered1"><a name="line595"></a> 595     end
</span><span class="inferred0"><a name="line596"></a> 596 
</span><span class="marked1"><a name="line597"></a> 597     def hard_break( text )
</span><span class="uncovered0"><a name="line598"></a> 598         text.gsub!( /(.)\n(?!\Z| *([#*=]+(\s|$)|[{|]))/, &quot;\\1&lt;br /&gt;&quot; ) if hard_breaks
</span><span class="uncovered1"><a name="line599"></a> 599     end
</span><span class="inferred0"><a name="line600"></a> 600 
</span><span class="marked1"><a name="line601"></a> 601     BLOCKS_GROUP_RE = /\n{2,}(?! )/m
</span><span class="inferred0"><a name="line602"></a> 602 
</span><span class="marked1"><a name="line603"></a> 603     def blocks( text, deep_code = false )
</span><span class="uncovered0"><a name="line604"></a> 604         text.replace( text.split( BLOCKS_GROUP_RE ).collect do |blk|
</span><span class="uncovered1"><a name="line605"></a> 605             plain = blk !~ /\A[#*&gt; ]/
</span><span class="uncovered0"><a name="line606"></a> 606 
</span><span class="uncovered1"><a name="line607"></a> 607             # skip blocks that are complex HTML
</span><span class="uncovered0"><a name="line608"></a> 608             if blk =~ /^&lt;\/?(\w+).*&gt;/ and not SIMPLE_HTML_TAGS.include? $1
</span><span class="uncovered1"><a name="line609"></a> 609                 blk
</span><span class="uncovered0"><a name="line610"></a> 610             else
</span><span class="uncovered1"><a name="line611"></a> 611                 # search for indentation levels
</span><span class="uncovered0"><a name="line612"></a> 612                 blk.strip!
</span><span class="uncovered1"><a name="line613"></a> 613                 if blk.empty?
</span><span class="uncovered0"><a name="line614"></a> 614                     blk
</span><span class="uncovered1"><a name="line615"></a> 615                 else
</span><span class="uncovered0"><a name="line616"></a> 616                     code_blk = nil
</span><span class="uncovered1"><a name="line617"></a> 617                     blk.gsub!( /((?:\n(?:\n^ +[^\n]*)+)+)/m ) do |iblk|
</span><span class="uncovered0"><a name="line618"></a> 618                         flush_left iblk
</span><span class="uncovered1"><a name="line619"></a> 619                         blocks iblk, plain
</span><span class="uncovered0"><a name="line620"></a> 620                         iblk.gsub( /^(\S)/, &quot;\t\\1&quot; )
</span><span class="uncovered1"><a name="line621"></a> 621                         if plain
</span><span class="uncovered0"><a name="line622"></a> 622                             code_blk = iblk; &quot;&quot;
</span><span class="uncovered1"><a name="line623"></a> 623                         else
</span><span class="uncovered0"><a name="line624"></a> 624                             iblk
</span><span class="uncovered1"><a name="line625"></a> 625                         end
</span><span class="uncovered0"><a name="line626"></a> 626                     end
</span><span class="uncovered1"><a name="line627"></a> 627 
</span><span class="uncovered0"><a name="line628"></a> 628                     block_applied = 0 
</span><span class="uncovered1"><a name="line629"></a> 629                     @rules.each do |rule_name|
</span><span class="uncovered0"><a name="line630"></a> 630                         block_applied += 1 if ( rule_name.to_s.match /^block_/ and method( rule_name ).call( blk ) )
</span><span class="uncovered1"><a name="line631"></a> 631                     end
</span><span class="uncovered0"><a name="line632"></a> 632                     if block_applied.zero?
</span><span class="uncovered1"><a name="line633"></a> 633                         if deep_code
</span><span class="uncovered0"><a name="line634"></a> 634                             blk = &quot;\t&lt;pre&gt;&lt;code&gt;#{ blk }&lt;/code&gt;&lt;/pre&gt;&quot;
</span><span class="uncovered1"><a name="line635"></a> 635                         else
</span><span class="uncovered0"><a name="line636"></a> 636                             blk = &quot;\t&lt;p&gt;#{ blk }&lt;/p&gt;&quot;
</span><span class="uncovered1"><a name="line637"></a> 637                         end
</span><span class="uncovered0"><a name="line638"></a> 638                     end
</span><span class="uncovered1"><a name="line639"></a> 639                     # hard_break blk
</span><span class="uncovered0"><a name="line640"></a> 640                     blk + &quot;\n#{ code_blk }&quot;
</span><span class="uncovered1"><a name="line641"></a> 641                 end
</span><span class="uncovered0"><a name="line642"></a> 642             end
</span><span class="uncovered1"><a name="line643"></a> 643 
</span><span class="uncovered0"><a name="line644"></a> 644         end.join( &quot;\n\n&quot; ) )
</span><span class="uncovered1"><a name="line645"></a> 645     end
</span><span class="inferred0"><a name="line646"></a> 646 
</span><span class="marked1"><a name="line647"></a> 647     def textile_bq( tag, atts, cite, content )
</span><span class="uncovered0"><a name="line648"></a> 648         cite, cite_title = check_refs( cite )
</span><span class="uncovered1"><a name="line649"></a> 649         cite = &quot; cite=\&quot;#{ cite }\&quot;&quot; if cite
</span><span class="uncovered0"><a name="line650"></a> 650         atts = shelve( atts ) if atts
</span><span class="uncovered1"><a name="line651"></a> 651         &quot;\t&lt;blockquote#{ cite }&gt;\n\t\t&lt;p#{ atts }&gt;#{ content }&lt;/p&gt;\n\t&lt;/blockquote&gt;&quot;
</span><span class="uncovered0"><a name="line652"></a> 652     end
</span><span class="inferred1"><a name="line653"></a> 653 
</span><span class="marked0"><a name="line654"></a> 654     def textile_p( tag, atts, cite, content )
</span><span class="uncovered1"><a name="line655"></a> 655         atts = shelve( atts ) if atts
</span><span class="uncovered0"><a name="line656"></a> 656         &quot;\t&lt;#{ tag }#{ atts }&gt;#{ content }&lt;/#{ tag }&gt;&quot;
</span><span class="uncovered1"><a name="line657"></a> 657     end
</span><span class="inferred0"><a name="line658"></a> 658 
</span><span class="marked1"><a name="line659"></a> 659     alias textile_h1 textile_p
</span><span class="marked0"><a name="line660"></a> 660     alias textile_h2 textile_p
</span><span class="marked1"><a name="line661"></a> 661     alias textile_h3 textile_p
</span><span class="marked0"><a name="line662"></a> 662     alias textile_h4 textile_p
</span><span class="marked1"><a name="line663"></a> 663     alias textile_h5 textile_p
</span><span class="marked0"><a name="line664"></a> 664     alias textile_h6 textile_p
</span><span class="inferred1"><a name="line665"></a> 665 
</span><span class="marked0"><a name="line666"></a> 666     def textile_fn_( tag, num, atts, cite, content )
</span><span class="uncovered1"><a name="line667"></a> 667         atts &lt;&lt; &quot; id=\&quot;fn#{ num }\&quot;&quot;
</span><span class="uncovered0"><a name="line668"></a> 668         content = &quot;&lt;sup&gt;#{ num }&lt;/sup&gt; #{ content }&quot;
</span><span class="uncovered1"><a name="line669"></a> 669         atts = shelve( atts ) if atts
</span><span class="uncovered0"><a name="line670"></a> 670         &quot;\t&lt;p#{ atts }&gt;#{ content }&lt;/p&gt;&quot;
</span><span class="uncovered1"><a name="line671"></a> 671     end
</span><span class="inferred0"><a name="line672"></a> 672 
</span><span class="marked1"><a name="line673"></a> 673     BLOCK_RE = /^(([a-z]+)(\d*))(#{A}#{C})\.(?::(\S+))? (.*)$/m
</span><span class="inferred0"><a name="line674"></a> 674 
</span><span class="marked1"><a name="line675"></a> 675     def block_textile_prefix( text ) 
</span><span class="uncovered0"><a name="line676"></a> 676         if text =~ BLOCK_RE
</span><span class="uncovered1"><a name="line677"></a> 677             tag,tagpre,num,atts,cite,content = $~[1..6]
</span><span class="uncovered0"><a name="line678"></a> 678             atts = pba( atts )
</span><span class="uncovered1"><a name="line679"></a> 679 
</span><span class="uncovered0"><a name="line680"></a> 680             # pass to prefix handler
</span><span class="uncovered1"><a name="line681"></a> 681             if respond_to? &quot;textile_#{ tag }&quot;, true
</span><span class="uncovered0"><a name="line682"></a> 682                 text.gsub!( $&amp;, method( &quot;textile_#{ tag }&quot; ).call( tag, atts, cite, content ) )
</span><span class="uncovered1"><a name="line683"></a> 683             elsif respond_to? &quot;textile_#{ tagpre }_&quot;, true
</span><span class="uncovered0"><a name="line684"></a> 684                 text.gsub!( $&amp;, method( &quot;textile_#{ tagpre }_&quot; ).call( tagpre, num, atts, cite, content ) )
</span><span class="uncovered1"><a name="line685"></a> 685             end
</span><span class="uncovered0"><a name="line686"></a> 686         end
</span><span class="uncovered1"><a name="line687"></a> 687     end
</span><span class="inferred0"><a name="line688"></a> 688     
</span><span class="marked1"><a name="line689"></a> 689     SETEXT_RE = /\A(.+?)\n([=-])[=-]* *$/m
</span><span class="marked0"><a name="line690"></a> 690     def block_markdown_setext( text )
</span><span class="uncovered1"><a name="line691"></a> 691         if text =~ SETEXT_RE
</span><span class="uncovered0"><a name="line692"></a> 692             tag = if $2 == &quot;=&quot;; &quot;h1&quot;; else; &quot;h2&quot;; end
</span><span class="uncovered1"><a name="line693"></a> 693             blk, cont = &quot;&lt;#{ tag }&gt;#{ $1 }&lt;/#{ tag }&gt;&quot;, $'
</span><span class="uncovered0"><a name="line694"></a> 694             blocks cont
</span><span class="uncovered1"><a name="line695"></a> 695             text.replace( blk + cont )
</span><span class="uncovered0"><a name="line696"></a> 696         end
</span><span class="uncovered1"><a name="line697"></a> 697     end
</span><span class="inferred0"><a name="line698"></a> 698 
</span><span class="marked1"><a name="line699"></a> 699     ATX_RE = /\A(\#{1,6})  # $1 = string of #'s
</span><span class="uncovered0"><a name="line700"></a> 700               [ ]*
</span><span class="uncovered1"><a name="line701"></a> 701               (.+?)       # $2 = Header text
</span><span class="uncovered0"><a name="line702"></a> 702               [ ]*
</span><span class="uncovered1"><a name="line703"></a> 703               \#*         # optional closing #'s (not counted)
</span><span class="uncovered0"><a name="line704"></a> 704               $/x
</span><span class="marked1"><a name="line705"></a> 705     def block_markdown_atx( text )
</span><span class="uncovered0"><a name="line706"></a> 706         if text =~ ATX_RE
</span><span class="uncovered1"><a name="line707"></a> 707             tag = &quot;h#{ $1.length }&quot;
</span><span class="uncovered0"><a name="line708"></a> 708             blk, cont = &quot;&lt;#{ tag }&gt;#{ $2 }&lt;/#{ tag }&gt;\n\n&quot;, $'
</span><span class="uncovered1"><a name="line709"></a> 709             blocks cont
</span><span class="uncovered0"><a name="line710"></a> 710             text.replace( blk + cont )
</span><span class="uncovered1"><a name="line711"></a> 711         end
</span><span class="uncovered0"><a name="line712"></a> 712     end
</span><span class="inferred1"><a name="line713"></a> 713 
</span><span class="marked0"><a name="line714"></a> 714     MARKDOWN_BQ_RE = /\A(^ *&gt; ?.+$(.+\n)*\n*)+/m
</span><span class="inferred1"><a name="line715"></a> 715 
</span><span class="marked0"><a name="line716"></a> 716     def block_markdown_bq( text )
</span><span class="uncovered1"><a name="line717"></a> 717         text.gsub!( MARKDOWN_BQ_RE ) do |blk|
</span><span class="uncovered0"><a name="line718"></a> 718             blk.gsub!( /^ *&gt; ?/, '' )
</span><span class="uncovered1"><a name="line719"></a> 719             flush_left blk
</span><span class="uncovered0"><a name="line720"></a> 720             blocks blk
</span><span class="uncovered1"><a name="line721"></a> 721             blk.gsub!( /^(\S)/, &quot;\t\\1&quot; )
</span><span class="uncovered0"><a name="line722"></a> 722             &quot;&lt;blockquote&gt;\n#{ blk }\n&lt;/blockquote&gt;\n\n&quot;
</span><span class="uncovered1"><a name="line723"></a> 723         end
</span><span class="uncovered0"><a name="line724"></a> 724     end
</span><span class="inferred1"><a name="line725"></a> 725 
</span><span class="marked0"><a name="line726"></a> 726     MARKDOWN_RULE_RE = /^(#{
</span><span class="marked1"><a name="line727"></a> 727         ['*', '-', '_'].collect { |ch| '( ?' + Regexp::quote( ch ) + ' ?){3,}' }.join( '|' )
</span><span class="inferred0"><a name="line728"></a> 728     })$/
</span><span class="inferred1"><a name="line729"></a> 729 
</span><span class="marked0"><a name="line730"></a> 730     def block_markdown_rule( text )
</span><span class="uncovered1"><a name="line731"></a> 731         text.gsub!( MARKDOWN_RULE_RE ) do |blk|
</span><span class="uncovered0"><a name="line732"></a> 732             &quot;&lt;hr /&gt;&quot;
</span><span class="uncovered1"><a name="line733"></a> 733         end
</span><span class="uncovered0"><a name="line734"></a> 734     end
</span><span class="inferred1"><a name="line735"></a> 735 
</span><span class="inferred0"><a name="line736"></a> 736     # XXX TODO XXX
</span><span class="marked1"><a name="line737"></a> 737     def block_markdown_lists( text )
</span><span class="inferred0"><a name="line738"></a> 738     end
</span><span class="inferred1"><a name="line739"></a> 739 
</span><span class="marked0"><a name="line740"></a> 740     def inline_textile_span( text ) 
</span><span class="uncovered1"><a name="line741"></a> 741         QTAGS.each do |qtag_rc, ht, qtag_re, rtype|
</span><span class="uncovered0"><a name="line742"></a> 742             text.gsub!( qtag_re ) do |m|
</span><span class="uncovered1"><a name="line743"></a> 743              
</span><span class="uncovered0"><a name="line744"></a> 744                 case rtype
</span><span class="uncovered1"><a name="line745"></a> 745                 when :limit
</span><span class="uncovered0"><a name="line746"></a> 746                     sta,qtag,atts,cite,content = $~[1..5]
</span><span class="uncovered1"><a name="line747"></a> 747                 else
</span><span class="uncovered0"><a name="line748"></a> 748                     qtag,atts,cite,content = $~[1..4]
</span><span class="uncovered1"><a name="line749"></a> 749                     sta = ''
</span><span class="uncovered0"><a name="line750"></a> 750                 end
</span><span class="uncovered1"><a name="line751"></a> 751                 atts = pba( atts )
</span><span class="uncovered0"><a name="line752"></a> 752                 atts &lt;&lt; &quot; cite=\&quot;#{ cite }\&quot;&quot; if cite
</span><span class="uncovered1"><a name="line753"></a> 753                 atts = shelve( atts ) if atts
</span><span class="uncovered0"><a name="line754"></a> 754 
</span><span class="uncovered1"><a name="line755"></a> 755                 &quot;#{ sta }&lt;#{ ht }#{ atts }&gt;#{ content }&lt;/#{ ht }&gt;&quot;
</span><span class="uncovered0"><a name="line756"></a> 756 
</span><span class="uncovered1"><a name="line757"></a> 757             end
</span><span class="uncovered0"><a name="line758"></a> 758         end
</span><span class="uncovered1"><a name="line759"></a> 759     end
</span><span class="inferred0"><a name="line760"></a> 760 
</span><span class="marked1"><a name="line761"></a> 761     LINK_RE = /
</span><span class="inferred0"><a name="line762"></a> 762             ([\s\[{(]|[#{PUNCT}])?     # $pre
</span><span class="inferred1"><a name="line763"></a> 763             &quot;                          # start
</span><span class="uncovered0"><a name="line764"></a> 764             (#{C})                     # $atts
</span><span class="uncovered1"><a name="line765"></a> 765             ([^&quot;]+?)                   # $text
</span><span class="uncovered0"><a name="line766"></a> 766             \s?
</span><span class="uncovered1"><a name="line767"></a> 767             (?:\(([^)]+?)\)(?=&quot;))?     # $title
</span><span class="uncovered0"><a name="line768"></a> 768             &quot;:
</span><span class="uncovered1"><a name="line769"></a> 769             (\S+?)                     # $url
</span><span class="uncovered0"><a name="line770"></a> 770             (\/)?                      # $slash
</span><span class="uncovered1"><a name="line771"></a> 771             ([^\w\/;]*?)               # $post
</span><span class="uncovered0"><a name="line772"></a> 772             (?=&lt;|\s|$)
</span><span class="uncovered1"><a name="line773"></a> 773         /x 
</span><span class="inferred0"><a name="line774"></a> 774 
</span><span class="marked1"><a name="line775"></a> 775     def inline_textile_link( text ) 
</span><span class="uncovered0"><a name="line776"></a> 776         text.gsub!( LINK_RE ) do |m|
</span><span class="uncovered1"><a name="line777"></a> 777             pre,atts,text,title,url,slash,post = $~[1..7]
</span><span class="uncovered0"><a name="line778"></a> 778 
</span><span class="uncovered1"><a name="line779"></a> 779             url, url_title = check_refs( url )
</span><span class="uncovered0"><a name="line780"></a> 780             title ||= url_title
</span><span class="uncovered1"><a name="line781"></a> 781             
</span><span class="uncovered0"><a name="line782"></a> 782             atts = pba( atts )
</span><span class="uncovered1"><a name="line783"></a> 783             atts = &quot; href=\&quot;#{ url }#{ slash }\&quot;#{ atts }&quot;
</span><span class="uncovered0"><a name="line784"></a> 784             atts &lt;&lt; &quot; title=\&quot;#{ title }\&quot;&quot; if title
</span><span class="uncovered1"><a name="line785"></a> 785             atts = shelve( atts ) if atts
</span><span class="uncovered0"><a name="line786"></a> 786             
</span><span class="uncovered1"><a name="line787"></a> 787             &quot;#{ pre }&lt;a#{ atts }&gt;#{ text }&lt;/a&gt;#{ post }&quot;
</span><span class="uncovered0"><a name="line788"></a> 788         end
</span><span class="uncovered1"><a name="line789"></a> 789     end
</span><span class="inferred0"><a name="line790"></a> 790 
</span><span class="marked1"><a name="line791"></a> 791     MARKDOWN_REFLINK_RE = /
</span><span class="inferred0"><a name="line792"></a> 792             \[([^\[\]]+)\]      # $text
</span><span class="uncovered1"><a name="line793"></a> 793             [ ]?                # opt. space
</span><span class="uncovered0"><a name="line794"></a> 794             (?:\n[ ]*)?         # one optional newline followed by spaces
</span><span class="uncovered1"><a name="line795"></a> 795             \[(.*?)\]           # $id
</span><span class="uncovered0"><a name="line796"></a> 796         /x 
</span><span class="inferred1"><a name="line797"></a> 797 
</span><span class="marked0"><a name="line798"></a> 798     def inline_markdown_reflink( text ) 
</span><span class="uncovered1"><a name="line799"></a> 799         text.gsub!( MARKDOWN_REFLINK_RE ) do |m|
</span><span class="uncovered0"><a name="line800"></a> 800             text, id = $~[1..2]
</span><span class="uncovered1"><a name="line801"></a> 801 
</span><span class="uncovered0"><a name="line802"></a> 802             if id.empty?
</span><span class="uncovered1"><a name="line803"></a> 803                 url, title = check_refs( text )
</span><span class="uncovered0"><a name="line804"></a> 804             else
</span><span class="uncovered1"><a name="line805"></a> 805                 url, title = check_refs( id )
</span><span class="uncovered0"><a name="line806"></a> 806             end
</span><span class="uncovered1"><a name="line807"></a> 807             
</span><span class="uncovered0"><a name="line808"></a> 808             atts = &quot; href=\&quot;#{ url }\&quot;&quot;
</span><span class="uncovered1"><a name="line809"></a> 809             atts &lt;&lt; &quot; title=\&quot;#{ title }\&quot;&quot; if title
</span><span class="uncovered0"><a name="line810"></a> 810             atts = shelve( atts )
</span><span class="uncovered1"><a name="line811"></a> 811             
</span><span class="uncovered0"><a name="line812"></a> 812             &quot;&lt;a#{ atts }&gt;#{ text }&lt;/a&gt;&quot;
</span><span class="uncovered1"><a name="line813"></a> 813         end
</span><span class="uncovered0"><a name="line814"></a> 814     end
</span><span class="inferred1"><a name="line815"></a> 815 
</span><span class="marked0"><a name="line816"></a> 816     MARKDOWN_LINK_RE = /
</span><span class="inferred1"><a name="line817"></a> 817             \[([^\[\]]+)\]      # $text
</span><span class="uncovered0"><a name="line818"></a> 818             \(                  # open paren
</span><span class="uncovered1"><a name="line819"></a> 819             [ \t]*              # opt space
</span><span class="uncovered0"><a name="line820"></a> 820             &lt;?(.+?)&gt;?           # $href
</span><span class="uncovered1"><a name="line821"></a> 821             [ \t]*              # opt space
</span><span class="uncovered0"><a name="line822"></a> 822             (?:                 # whole title
</span><span class="uncovered1"><a name="line823"></a> 823             (['&quot;])              # $quote
</span><span class="uncovered0"><a name="line824"></a> 824             (.*?)               # $title
</span><span class="uncovered1"><a name="line825"></a> 825             \3                  # matching quote
</span><span class="uncovered0"><a name="line826"></a> 826             )?                  # title is optional
</span><span class="uncovered1"><a name="line827"></a> 827             \)
</span><span class="uncovered0"><a name="line828"></a> 828         /x 
</span><span class="inferred1"><a name="line829"></a> 829 
</span><span class="marked0"><a name="line830"></a> 830     def inline_markdown_link( text ) 
</span><span class="uncovered1"><a name="line831"></a> 831         text.gsub!( MARKDOWN_LINK_RE ) do |m|
</span><span class="uncovered0"><a name="line832"></a> 832             text, url, quote, title = $~[1..4]
</span><span class="uncovered1"><a name="line833"></a> 833 
</span><span class="uncovered0"><a name="line834"></a> 834             atts = &quot; href=\&quot;#{ url }\&quot;&quot;
</span><span class="uncovered1"><a name="line835"></a> 835             atts &lt;&lt; &quot; title=\&quot;#{ title }\&quot;&quot; if title
</span><span class="uncovered0"><a name="line836"></a> 836             atts = shelve( atts )
</span><span class="uncovered1"><a name="line837"></a> 837             
</span><span class="uncovered0"><a name="line838"></a> 838             &quot;&lt;a#{ atts }&gt;#{ text }&lt;/a&gt;&quot;
</span><span class="uncovered1"><a name="line839"></a> 839         end
</span><span class="uncovered0"><a name="line840"></a> 840     end
</span><span class="inferred1"><a name="line841"></a> 841 
</span><span class="marked0"><a name="line842"></a> 842     TEXTILE_REFS_RE =  /(^ *)\[([^\n]+?)\](#{HYPERLINK})(?=\s|$)/
</span><span class="marked1"><a name="line843"></a> 843     MARKDOWN_REFS_RE = /(^ *)\[([^\n]+?)\]:\s+&lt;?(#{HYPERLINK})&gt;?(?:\s+&quot;((?:[^&quot;]|\\&quot;)+)&quot;)?(?=\s|$)/m
</span><span class="inferred0"><a name="line844"></a> 844 
</span><span class="marked1"><a name="line845"></a> 845     def refs( text )
</span><span class="uncovered0"><a name="line846"></a> 846         @rules.each do |rule_name|
</span><span class="uncovered1"><a name="line847"></a> 847             method( rule_name ).call( text ) if rule_name.to_s.match /^refs_/
</span><span class="uncovered0"><a name="line848"></a> 848         end
</span><span class="uncovered1"><a name="line849"></a> 849     end
</span><span class="inferred0"><a name="line850"></a> 850 
</span><span class="marked1"><a name="line851"></a> 851     def refs_textile( text ) 
</span><span class="uncovered0"><a name="line852"></a> 852         text.gsub!( TEXTILE_REFS_RE ) do |m|
</span><span class="uncovered1"><a name="line853"></a> 853             flag, url = $~[2..3]
</span><span class="uncovered0"><a name="line854"></a> 854             @urlrefs[flag.downcase] = [url, nil]
</span><span class="uncovered1"><a name="line855"></a> 855             nil
</span><span class="uncovered0"><a name="line856"></a> 856         end
</span><span class="uncovered1"><a name="line857"></a> 857     end
</span><span class="inferred0"><a name="line858"></a> 858     
</span><span class="marked1"><a name="line859"></a> 859     def refs_markdown( text )
</span><span class="uncovered0"><a name="line860"></a> 860         text.gsub!( MARKDOWN_REFS_RE ) do |m|
</span><span class="uncovered1"><a name="line861"></a> 861             flag, url = $~[2..3]
</span><span class="uncovered0"><a name="line862"></a> 862             title = $~[6]
</span><span class="uncovered1"><a name="line863"></a> 863             @urlrefs[flag.downcase] = [url, title]
</span><span class="uncovered0"><a name="line864"></a> 864             nil
</span><span class="uncovered1"><a name="line865"></a> 865         end
</span><span class="uncovered0"><a name="line866"></a> 866     end
</span><span class="inferred1"><a name="line867"></a> 867 
</span><span class="marked0"><a name="line868"></a> 868     def check_refs( text ) 
</span><span class="uncovered1"><a name="line869"></a> 869         ret = @urlrefs[text.downcase] if text
</span><span class="uncovered0"><a name="line870"></a> 870         ret || [text, nil]
</span><span class="uncovered1"><a name="line871"></a> 871     end
</span><span class="inferred0"><a name="line872"></a> 872 
</span><span class="marked1"><a name="line873"></a> 873     IMAGE_RE = /
</span><span class="inferred0"><a name="line874"></a> 874             (&lt;p&gt;|.|^)            # start of line?
</span><span class="uncovered1"><a name="line875"></a> 875             \!                   # opening
</span><span class="uncovered0"><a name="line876"></a> 876             (\&lt;|\=|\&gt;)?          # optional alignment atts
</span><span class="uncovered1"><a name="line877"></a> 877             (#{C})               # optional style,class atts
</span><span class="uncovered0"><a name="line878"></a> 878             (?:\. )?             # optional dot-space
</span><span class="uncovered1"><a name="line879"></a> 879             ([^\s(!]+?)          # presume this is the src
</span><span class="uncovered0"><a name="line880"></a> 880             \s?                  # optional space
</span><span class="uncovered1"><a name="line881"></a> 881             (?:\(((?:[^\(\)]|\([^\)]+\))+?)\))?   # optional title
</span><span class="uncovered0"><a name="line882"></a> 882             \!                   # closing
</span><span class="uncovered1"><a name="line883"></a> 883             (?::#{ HYPERLINK })? # optional href
</span><span class="uncovered0"><a name="line884"></a> 884         /x 
</span><span class="inferred1"><a name="line885"></a> 885 
</span><span class="marked0"><a name="line886"></a> 886     def inline_textile_image( text ) 
</span><span class="uncovered1"><a name="line887"></a> 887         text.gsub!( IMAGE_RE )  do |m|
</span><span class="uncovered0"><a name="line888"></a> 888             stln,algn,atts,url,title,href,href_a1,href_a2 = $~[1..8]
</span><span class="uncovered1"><a name="line889"></a> 889             atts = pba( atts )
</span><span class="uncovered0"><a name="line890"></a> 890             atts = &quot; src=\&quot;#{ url }\&quot;#{ atts }&quot;
</span><span class="uncovered1"><a name="line891"></a> 891             atts &lt;&lt; &quot; title=\&quot;#{ title }\&quot;&quot; if title
</span><span class="uncovered0"><a name="line892"></a> 892             atts &lt;&lt; &quot; alt=\&quot;#{ title }\&quot;&quot; 
</span><span class="uncovered1"><a name="line893"></a> 893             # size = @getimagesize($url);
</span><span class="uncovered0"><a name="line894"></a> 894             # if($size) $atts.= &quot; $size[3]&quot;;
</span><span class="uncovered1"><a name="line895"></a> 895 
</span><span class="uncovered0"><a name="line896"></a> 896             href, alt_title = check_refs( href ) if href
</span><span class="uncovered1"><a name="line897"></a> 897             url, url_title = check_refs( url )
</span><span class="uncovered0"><a name="line898"></a> 898 
</span><span class="uncovered1"><a name="line899"></a> 899             out = ''
</span><span class="uncovered0"><a name="line900"></a> 900             out &lt;&lt; &quot;&lt;a#{ shelve( &quot; href=\&quot;#{ href }\&quot;&quot; ) }&gt;&quot; if href
</span><span class="uncovered1"><a name="line901"></a> 901             out &lt;&lt; &quot;&lt;img#{ shelve( atts ) } /&gt;&quot;
</span><span class="uncovered0"><a name="line902"></a> 902             out &lt;&lt; &quot;&lt;/a&gt;#{ href_a1 }#{ href_a2 }&quot; if href
</span><span class="uncovered1"><a name="line903"></a> 903             
</span><span class="uncovered0"><a name="line904"></a> 904             if algn 
</span><span class="uncovered1"><a name="line905"></a> 905                 algn = h_align( algn )
</span><span class="uncovered0"><a name="line906"></a> 906                 if stln == &quot;&lt;p&gt;&quot;
</span><span class="uncovered1"><a name="line907"></a> 907                     out = &quot;&lt;p style=\&quot;float:#{ algn }\&quot;&gt;#{ out }&quot;
</span><span class="uncovered0"><a name="line908"></a> 908                 else
</span><span class="uncovered1"><a name="line909"></a> 909                     out = &quot;#{ stln }&lt;div style=\&quot;float:#{ algn }\&quot;&gt;#{ out }&lt;/div&gt;&quot;
</span><span class="uncovered0"><a name="line910"></a> 910                 end
</span><span class="uncovered1"><a name="line911"></a> 911             else
</span><span class="uncovered0"><a name="line912"></a> 912                 out = stln + out
</span><span class="uncovered1"><a name="line913"></a> 913             end
</span><span class="uncovered0"><a name="line914"></a> 914 
</span><span class="uncovered1"><a name="line915"></a> 915             out
</span><span class="uncovered0"><a name="line916"></a> 916         end
</span><span class="uncovered1"><a name="line917"></a> 917     end
</span><span class="inferred0"><a name="line918"></a> 918 
</span><span class="marked1"><a name="line919"></a> 919     def shelve( val ) 
</span><span class="uncovered0"><a name="line920"></a> 920         @shelf &lt;&lt; val
</span><span class="uncovered1"><a name="line921"></a> 921         &quot; :redsh##{ @shelf.length }:&quot;
</span><span class="uncovered0"><a name="line922"></a> 922     end
</span><span class="inferred1"><a name="line923"></a> 923     
</span><span class="marked0"><a name="line924"></a> 924     def retrieve( text ) 
</span><span class="uncovered1"><a name="line925"></a> 925         @shelf.each_with_index do |r, i|
</span><span class="uncovered0"><a name="line926"></a> 926             text.gsub!( &quot; :redsh##{ i + 1 }:&quot;, r )
</span><span class="uncovered1"><a name="line927"></a> 927         end
</span><span class="uncovered0"><a name="line928"></a> 928     end
</span><span class="inferred1"><a name="line929"></a> 929 
</span><span class="marked0"><a name="line930"></a> 930     def incoming_entities( text ) 
</span><span class="uncovered1"><a name="line931"></a> 931         ## turn any incoming ampersands into a dummy character for now.
</span><span class="uncovered0"><a name="line932"></a> 932         ## This uses a negative lookahead for alphanumerics followed by a semicolon,
</span><span class="uncovered1"><a name="line933"></a> 933         ## implying an incoming html entity, to be skipped
</span><span class="uncovered0"><a name="line934"></a> 934 
</span><span class="uncovered1"><a name="line935"></a> 935         text.gsub!( /&amp;(?![#a-z0-9]+;)/i, &quot;x%x%&quot; )
</span><span class="uncovered0"><a name="line936"></a> 936     end
</span><span class="inferred1"><a name="line937"></a> 937 
</span><span class="marked0"><a name="line938"></a> 938     def no_textile( text ) 
</span><span class="uncovered1"><a name="line939"></a> 939         text.gsub!( /(^|\s)==([^=]+.*?)==(\s|$)?/,
</span><span class="uncovered0"><a name="line940"></a> 940             '\1&lt;notextile&gt;\2&lt;/notextile&gt;\3' )
</span><span class="uncovered1"><a name="line941"></a> 941         text.gsub!( /^ *==([^=]+.*?)==/m,
</span><span class="uncovered0"><a name="line942"></a> 942             '\1&lt;notextile&gt;\2&lt;/notextile&gt;\3' )
</span><span class="uncovered1"><a name="line943"></a> 943     end
</span><span class="inferred0"><a name="line944"></a> 944 
</span><span class="marked1"><a name="line945"></a> 945     def clean_white_space( text ) 
</span><span class="uncovered0"><a name="line946"></a> 946         # normalize line breaks
</span><span class="uncovered1"><a name="line947"></a> 947         text.gsub!( /\r\n/, &quot;\n&quot; )
</span><span class="uncovered0"><a name="line948"></a> 948         text.gsub!( /\r/, &quot;\n&quot; )
</span><span class="uncovered1"><a name="line949"></a> 949         text.gsub!( /\t/, '    ' )
</span><span class="uncovered0"><a name="line950"></a> 950         text.gsub!( /^ +$/, '' )
</span><span class="uncovered1"><a name="line951"></a> 951         text.gsub!( /\n{3,}/, &quot;\n\n&quot; )
</span><span class="uncovered0"><a name="line952"></a> 952         text.gsub!( /&quot;$/, &quot;\&quot; &quot; )
</span><span class="uncovered1"><a name="line953"></a> 953 
</span><span class="uncovered0"><a name="line954"></a> 954         # if entire document is indented, flush
</span><span class="uncovered1"><a name="line955"></a> 955         # to the left side
</span><span class="uncovered0"><a name="line956"></a> 956         flush_left text
</span><span class="uncovered1"><a name="line957"></a> 957     end
</span><span class="inferred0"><a name="line958"></a> 958 
</span><span class="marked1"><a name="line959"></a> 959     def flush_left( text )
</span><span class="uncovered0"><a name="line960"></a> 960         indt = 0
</span><span class="uncovered1"><a name="line961"></a> 961         if text =~ /^ /
</span><span class="uncovered0"><a name="line962"></a> 962             while text !~ /^ {#{indt}}\S/
</span><span class="uncovered1"><a name="line963"></a> 963                 indt += 1
</span><span class="uncovered0"><a name="line964"></a> 964             end unless text.empty?
</span><span class="uncovered1"><a name="line965"></a> 965             if indt.nonzero?
</span><span class="uncovered0"><a name="line966"></a> 966                 text.gsub!( /^ {#{indt}}/, '' )
</span><span class="uncovered1"><a name="line967"></a> 967             end
</span><span class="uncovered0"><a name="line968"></a> 968         end
</span><span class="uncovered1"><a name="line969"></a> 969     end
</span><span class="inferred0"><a name="line970"></a> 970 
</span><span class="marked1"><a name="line971"></a> 971     def footnote_ref( text ) 
</span><span class="uncovered0"><a name="line972"></a> 972         text.gsub!( /\b\[([0-9]+?)\](\s)?/,
</span><span class="uncovered1"><a name="line973"></a> 973             '&lt;sup&gt;&lt;a href=&quot;#fn\1&quot;&gt;\1&lt;/a&gt;&lt;/sup&gt;\2' )
</span><span class="uncovered0"><a name="line974"></a> 974     end
</span><span class="inferred1"><a name="line975"></a> 975     
</span><span class="marked0"><a name="line976"></a> 976     OFFTAGS = /(code|pre|kbd|notextile)/
</span><span class="marked1"><a name="line977"></a> 977     OFFTAG_MATCH = /(?:(&lt;\/#{ OFFTAGS }&gt;)|(&lt;#{ OFFTAGS }[^&gt;]*&gt;))(.*?)(?=&lt;\/?#{ OFFTAGS }|\Z)/mi
</span><span class="marked0"><a name="line978"></a> 978     OFFTAG_OPEN = /&lt;#{ OFFTAGS }/
</span><span class="marked1"><a name="line979"></a> 979     OFFTAG_CLOSE = /&lt;\/?#{ OFFTAGS }/
</span><span class="marked0"><a name="line980"></a> 980     HASTAG_MATCH = /(&lt;\/?\w[^\n]*?&gt;)/m
</span><span class="marked1"><a name="line981"></a> 981     ALLTAG_MATCH = /(&lt;\/?\w[^\n]*?&gt;)|.*?(?=&lt;\/?\w[^\n]*?&gt;|$)/m
</span><span class="inferred0"><a name="line982"></a> 982 
</span><span class="marked1"><a name="line983"></a> 983     def glyphs_textile( text, level = 0 )
</span><span class="uncovered0"><a name="line984"></a> 984         if text !~ HASTAG_MATCH
</span><span class="uncovered1"><a name="line985"></a> 985             pgl text
</span><span class="uncovered0"><a name="line986"></a> 986             footnote_ref text
</span><span class="uncovered1"><a name="line987"></a> 987         else
</span><span class="uncovered0"><a name="line988"></a> 988             codepre = 0
</span><span class="uncovered1"><a name="line989"></a> 989             text.gsub!( ALLTAG_MATCH ) do |line|
</span><span class="uncovered0"><a name="line990"></a> 990                 ## matches are off if we're between &lt;code&gt;, &lt;pre&gt; etc.
</span><span class="uncovered1"><a name="line991"></a> 991                 if $1
</span><span class="uncovered0"><a name="line992"></a> 992                     if line =~ OFFTAG_OPEN
</span><span class="uncovered1"><a name="line993"></a> 993                         codepre += 1
</span><span class="uncovered0"><a name="line994"></a> 994                     elsif line =~ OFFTAG_CLOSE
</span><span class="uncovered1"><a name="line995"></a> 995                         codepre -= 1
</span><span class="uncovered0"><a name="line996"></a> 996                         codepre = 0 if codepre &lt; 0
</span><span class="uncovered1"><a name="line997"></a> 997                     end 
</span><span class="uncovered0"><a name="line998"></a> 998                 elsif codepre.zero?
</span><span class="uncovered1"><a name="line999"></a> 999                     glyphs_textile( line, level + 1 )
</span><span class="uncovered0"><a name="line1000"></a>1000                 else
</span><span class="uncovered1"><a name="line1001"></a>1001                     htmlesc( line, :NoQuotes )
</span><span class="uncovered0"><a name="line1002"></a>1002                 end
</span><span class="uncovered1"><a name="line1003"></a>1003                 # p [level, codepre, line]
</span><span class="uncovered0"><a name="line1004"></a>1004 
</span><span class="uncovered1"><a name="line1005"></a>1005                 line
</span><span class="uncovered0"><a name="line1006"></a>1006             end
</span><span class="uncovered1"><a name="line1007"></a>1007         end
</span><span class="uncovered0"><a name="line1008"></a>1008     end
</span><span class="inferred1"><a name="line1009"></a>1009 
</span><span class="marked0"><a name="line1010"></a>1010     def rip_offtags( text )
</span><span class="uncovered1"><a name="line1011"></a>1011         if text =~ /&lt;.*&gt;/
</span><span class="uncovered0"><a name="line1012"></a>1012             ## strip and encode &lt;pre&gt; content
</span><span class="uncovered1"><a name="line1013"></a>1013             codepre, used_offtags = 0, {}
</span><span class="uncovered0"><a name="line1014"></a>1014             text.gsub!( OFFTAG_MATCH ) do |line|
</span><span class="uncovered1"><a name="line1015"></a>1015                 if $3
</span><span class="uncovered0"><a name="line1016"></a>1016                     offtag, aftertag = $4, $5
</span><span class="uncovered1"><a name="line1017"></a>1017                     codepre += 1
</span><span class="uncovered0"><a name="line1018"></a>1018                     used_offtags[offtag] = true
</span><span class="uncovered1"><a name="line1019"></a>1019                     if codepre - used_offtags.length &gt; 0
</span><span class="uncovered0"><a name="line1020"></a>1020                         htmlesc( line, :NoQuotes ) unless used_offtags['notextile']
</span><span class="uncovered1"><a name="line1021"></a>1021                         @pre_list.last &lt;&lt; line
</span><span class="uncovered0"><a name="line1022"></a>1022                         line = &quot;&quot;
</span><span class="uncovered1"><a name="line1023"></a>1023                     else
</span><span class="uncovered0"><a name="line1024"></a>1024                         htmlesc( aftertag, :NoQuotes ) if aftertag and not used_offtags['notextile']
</span><span class="uncovered1"><a name="line1025"></a>1025                         line = &quot;&lt;redpre##{ @pre_list.length }&gt;&quot;
</span><span class="uncovered0"><a name="line1026"></a>1026                         @pre_list &lt;&lt; &quot;#{ $3 }#{ aftertag }&quot;
</span><span class="uncovered1"><a name="line1027"></a>1027                     end
</span><span class="uncovered0"><a name="line1028"></a>1028                 elsif $1 and codepre &gt; 0
</span><span class="uncovered1"><a name="line1029"></a>1029                     if codepre - used_offtags.length &gt; 0
</span><span class="uncovered0"><a name="line1030"></a>1030                         htmlesc( line, :NoQuotes ) unless used_offtags['notextile']
</span><span class="uncovered1"><a name="line1031"></a>1031                         @pre_list.last &lt;&lt; line
</span><span class="uncovered0"><a name="line1032"></a>1032                         line = &quot;&quot;
</span><span class="uncovered1"><a name="line1033"></a>1033                     end
</span><span class="uncovered0"><a name="line1034"></a>1034                     codepre -= 1 unless codepre.zero?
</span><span class="uncovered1"><a name="line1035"></a>1035                     used_offtags = {} if codepre.zero?
</span><span class="uncovered0"><a name="line1036"></a>1036                 end 
</span><span class="uncovered1"><a name="line1037"></a>1037                 line
</span><span class="uncovered0"><a name="line1038"></a>1038             end
</span><span class="uncovered1"><a name="line1039"></a>1039         end
</span><span class="uncovered0"><a name="line1040"></a>1040         text
</span><span class="uncovered1"><a name="line1041"></a>1041     end
</span><span class="inferred0"><a name="line1042"></a>1042 
</span><span class="marked1"><a name="line1043"></a>1043     def smooth_offtags( text )
</span><span class="uncovered0"><a name="line1044"></a>1044         unless @pre_list.empty?
</span><span class="uncovered1"><a name="line1045"></a>1045             ## replace &lt;pre&gt; content
</span><span class="uncovered0"><a name="line1046"></a>1046             text.gsub!( /&lt;redpre#(\d+)&gt;/ ) { @pre_list[$1.to_i] }
</span><span class="uncovered1"><a name="line1047"></a>1047         end
</span><span class="uncovered0"><a name="line1048"></a>1048     end
</span><span class="inferred1"><a name="line1049"></a>1049 
</span><span class="marked0"><a name="line1050"></a>1050     def inline( text ) 
</span><span class="uncovered1"><a name="line1051"></a>1051         [/^inline_/, /^glyphs_/].each do |meth_re|
</span><span class="uncovered0"><a name="line1052"></a>1052             @rules.each do |rule_name|
</span><span class="uncovered1"><a name="line1053"></a>1053                 method( rule_name ).call( text ) if rule_name.to_s.match( meth_re )
</span><span class="uncovered0"><a name="line1054"></a>1054             end
</span><span class="uncovered1"><a name="line1055"></a>1055         end
</span><span class="uncovered0"><a name="line1056"></a>1056     end
</span><span class="inferred1"><a name="line1057"></a>1057 
</span><span class="marked0"><a name="line1058"></a>1058     def h_align( text ) 
</span><span class="uncovered1"><a name="line1059"></a>1059         H_ALGN_VALS[text]
</span><span class="uncovered0"><a name="line1060"></a>1060     end
</span><span class="inferred1"><a name="line1061"></a>1061 
</span><span class="marked0"><a name="line1062"></a>1062     def v_align( text ) 
</span><span class="uncovered1"><a name="line1063"></a>1063         V_ALGN_VALS[text]
</span><span class="uncovered0"><a name="line1064"></a>1064     end
</span><span class="inferred1"><a name="line1065"></a>1065 
</span><span class="marked0"><a name="line1066"></a>1066     def textile_popup_help( name, windowW, windowH )
</span><span class="uncovered1"><a name="line1067"></a>1067         ' &lt;a target=&quot;_blank&quot; href=&quot;http://hobix.com/textile/#' + helpvar + '&quot; onclick=&quot;window.open(this.href, \'popupwindow\', \'width=' + windowW + ',height=' + windowH + ',scrollbars,resizable\'); return false;&quot;&gt;' + name + '&lt;/a&gt;&lt;br /&gt;'
</span><span class="uncovered0"><a name="line1068"></a>1068     end
</span><span class="inferred1"><a name="line1069"></a>1069 
</span><span class="inferred0"><a name="line1070"></a>1070     # HTML cleansing stuff
</span><span class="marked1"><a name="line1071"></a>1071     BASIC_TAGS = {
</span><span class="inferred0"><a name="line1072"></a>1072         'a' =&gt; ['href', 'title'],
</span><span class="inferred1"><a name="line1073"></a>1073         'img' =&gt; ['src', 'alt', 'title'],
</span><span class="inferred0"><a name="line1074"></a>1074         'br' =&gt; [],
</span><span class="inferred1"><a name="line1075"></a>1075         'i' =&gt; nil,
</span><span class="inferred0"><a name="line1076"></a>1076         'u' =&gt; nil, 
</span><span class="inferred1"><a name="line1077"></a>1077         'b' =&gt; nil,
</span><span class="inferred0"><a name="line1078"></a>1078         'pre' =&gt; nil,
</span><span class="inferred1"><a name="line1079"></a>1079         'kbd' =&gt; nil,
</span><span class="inferred0"><a name="line1080"></a>1080         'code' =&gt; ['lang'],
</span><span class="inferred1"><a name="line1081"></a>1081         'cite' =&gt; nil,
</span><span class="inferred0"><a name="line1082"></a>1082         'strong' =&gt; nil,
</span><span class="inferred1"><a name="line1083"></a>1083         'em' =&gt; nil,
</span><span class="inferred0"><a name="line1084"></a>1084         'ins' =&gt; nil,
</span><span class="inferred1"><a name="line1085"></a>1085         'sup' =&gt; nil,
</span><span class="inferred0"><a name="line1086"></a>1086         'sub' =&gt; nil,
</span><span class="inferred1"><a name="line1087"></a>1087         'del' =&gt; nil,
</span><span class="inferred0"><a name="line1088"></a>1088         'table' =&gt; nil,
</span><span class="inferred1"><a name="line1089"></a>1089         'tr' =&gt; nil,
</span><span class="inferred0"><a name="line1090"></a>1090         'td' =&gt; ['colspan', 'rowspan'],
</span><span class="inferred1"><a name="line1091"></a>1091         'th' =&gt; nil,
</span><span class="inferred0"><a name="line1092"></a>1092         'ol' =&gt; nil,
</span><span class="inferred1"><a name="line1093"></a>1093         'ul' =&gt; nil,
</span><span class="inferred0"><a name="line1094"></a>1094         'li' =&gt; nil,
</span><span class="inferred1"><a name="line1095"></a>1095         'p' =&gt; nil,
</span><span class="inferred0"><a name="line1096"></a>1096         'h1' =&gt; nil,
</span><span class="inferred1"><a name="line1097"></a>1097         'h2' =&gt; nil,
</span><span class="inferred0"><a name="line1098"></a>1098         'h3' =&gt; nil,
</span><span class="inferred1"><a name="line1099"></a>1099         'h4' =&gt; nil,
</span><span class="inferred0"><a name="line1100"></a>1100         'h5' =&gt; nil,
</span><span class="inferred1"><a name="line1101"></a>1101         'h6' =&gt; nil, 
</span><span class="inferred0"><a name="line1102"></a>1102         'blockquote' =&gt; ['cite']
</span><span class="inferred1"><a name="line1103"></a>1103     }
</span><span class="inferred0"><a name="line1104"></a>1104 
</span><span class="marked1"><a name="line1105"></a>1105     def clean_html( text, tags = BASIC_TAGS )
</span><span class="uncovered0"><a name="line1106"></a>1106         text.gsub!( /&lt;!\[CDATA\[/, '' )
</span><span class="uncovered1"><a name="line1107"></a>1107         text.gsub!( /&lt;(\/*)(\w+)([^&gt;]*)&gt;/ ) do
</span><span class="uncovered0"><a name="line1108"></a>1108             raw = $~
</span><span class="uncovered1"><a name="line1109"></a>1109             tag = raw[2].downcase
</span><span class="uncovered0"><a name="line1110"></a>1110             if tags.has_key? tag
</span><span class="uncovered1"><a name="line1111"></a>1111                 pcs = [tag]
</span><span class="uncovered0"><a name="line1112"></a>1112                 tags[tag].each do |prop|
</span><span class="uncovered1"><a name="line1113"></a>1113                     ['&quot;', &quot;'&quot;, ''].each do |q|
</span><span class="uncovered0"><a name="line1114"></a>1114                         q2 = ( q != '' ? q : '\s' )
</span><span class="uncovered1"><a name="line1115"></a>1115                         if raw[3] =~ /#{prop}\s*=\s*#{q}([^#{q2}]+)#{q}/i
</span><span class="uncovered0"><a name="line1116"></a>1116                             attrv = $1
</span><span class="uncovered1"><a name="line1117"></a>1117                             next if prop == 'src' and attrv =~ %r{^(?!http)\w+:}
</span><span class="uncovered0"><a name="line1118"></a>1118                             pcs &lt;&lt; &quot;#{prop}=\&quot;#{$1.gsub('&quot;', '\\&quot;')}\&quot;&quot;
</span><span class="uncovered1"><a name="line1119"></a>1119                             break
</span><span class="uncovered0"><a name="line1120"></a>1120                         end
</span><span class="uncovered1"><a name="line1121"></a>1121                     end
</span><span class="uncovered0"><a name="line1122"></a>1122                 end if tags[tag]
</span><span class="uncovered1"><a name="line1123"></a>1123                 &quot;&lt;#{raw[1]}#{pcs.join &quot; &quot;}&gt;&quot;
</span><span class="uncovered0"><a name="line1124"></a>1124             else
</span><span class="uncovered1"><a name="line1125"></a>1125                 &quot; &quot;
</span><span class="uncovered0"><a name="line1126"></a>1126             end
</span><span class="uncovered1"><a name="line1127"></a>1127         end
</span><span class="uncovered0"><a name="line1128"></a>1128     end
</span><span class="uncovered1"><a name="line1129"></a>1129 end
</span><span class="inferred0"><a name="line1130"></a>1130 
</span></pre><hr/>
    <p>Generated using the <a href='http://eigenclass.org/hiki.rb?rcov'>rcov code coverage analysis tool for Ruby</a>
   version 0.8.1.2.</p>
<p><a href='http://validator.w3.org/check/referer'><img src='http://www.w3.org/Icons/valid-xhtml10' height='31' alt='Valid XHTML 1.0!' width='88'/>
        </a>
      <a href='http://jigsaw.w3.org/css-validator/check/referer'><img src='http://jigsaw.w3.org/css-validator/images/vcss' alt='Valid CSS!' style='border:0;width:88px;height:31px'/>
        </a>
      </p>
    </body>
  </html>
